<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="./logo.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self' https://cdn.jsdelivr.net; font-src 'self' data:; object-src 'none'; base-uri 'self'"
    />
    <title>ILMATRIX ‚Äî App</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#0f0e85",
              secondary: "#e44c99",
              tertiary: "#1b612f",
            },
          },
        },
      };
    </script>
    <!-- SEO meta -->
    <link rel="canonical" href="/app" />
    <meta
      name="description"
      content="ILMATRIX App ‚Äî Upload PDF, DOCX, PPTX, or images. Explain with citations, generate MCQ quizzes with deterministic grading, create flashcards, draft forum replies, prepare for exams, and chat with context."
    />
    <meta
      name="keywords"
      content="ILMATRIX app, study AI, quiz generator, MCQ, flashcards, explain material, forum reply, exam helper, OCR, PDF to text, DOCX, PPTX, university, belajar, kuliah"
    />
    <meta
      name="robots"
      content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1"
    />
    <meta name="author" content="ILMATRIX" />
    <!-- Browser UI colors (progressive enhancement) -->
    <meta name="color-scheme" content="light dark" />
    <meta name="msapplication-TileColor" content="#0f0e85" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <script>
      (function () {
        try {
          var lightColor = "#0f0e85";
          var darkColor = "#000000";
          var mql =
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)");
          var apply = function () {
            var content = mql && mql.matches ? darkColor : lightColor;
            var meta = document.querySelector('meta[name="theme-color"]');
            if (!meta) {
              meta = document.createElement("meta");
              meta.setAttribute("name", "theme-color");
              document.head.appendChild(meta);
            }
            meta.setAttribute("content", content);
          };
          apply();
          if (mql && mql.addEventListener)
            mql.addEventListener("change", apply);
          else if (mql && mql.addListener) mql.addListener(apply);
        } catch (e) {}
      })();
    </script>
    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="ILMATRIX ‚Äî App (Explain, MCQ, Flashcards, Forum, Exam, Chat)"
    />
    <meta
      property="og:description"
      content="Study companion grounded in your materials. Explain, MCQ with deterministic grading, flashcards, forum replies, exam helper, and chat."
    />
    <meta property="og:url" content="/app.html" />
    <meta property="og:image" content="/logo.svg" />
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="ILMATRIX ‚Äî App" />
    <meta
      name="twitter:description"
      content="Explain, MCQ, Flashcards, Forum, Exam ‚Äî grounded in your materials."
    />
    <meta name="twitter:image" content="/logo.svg" />
    <!-- hreflang -->
    <link rel="alternate" href="/app" hreflang="en" />
    <link rel="alternate" href="/app" hreflang="x-default" />

    <!-- Structured data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
          { "@type": "ListItem", "position": 1, "name": "Home", "item": "/" },
          {
            "@type": "ListItem",
            "position": 2,
            "name": "App",
            "item": "/app.html"
          }
        ]
      }
    </script>
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "ILMATRIX",
        "applicationCategory": "EducationalApplication",
        "operatingSystem": "Web",
        "url": "/app.html",
        "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" }
      }
    </script>
    <!-- Markdown renderer + sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

    <style>
      html {
        scroll-behavior: smooth;
      }
      /* Apply where supported */
      @supports (scrollbar-gutter: stable) {
        html {
          scrollbar-gutter: stable both-edges;
        }
      }
      /* Flashcard flip styles */
      .fc-scene {
        perspective: 1000px;
      }
      .fc-card {
        position: relative;
        width: 100%;
        height: 11rem; /* ~h-44 */
        transform-style: preserve-3d;
        transition: transform 0.6s;
        cursor: pointer;
        -webkit-user-select: none;
        user-select: none;
      }
      @media (min-width: 640px) {
        .fc-card {
          height: 12rem;
        } /* sm:h-48 */
      }
      .fc-card.is-flipped {
        transform: rotateY(180deg);
      }
      /* Mobile-friendly global clamps */
      html,
      body {
        max-width: 100%;
        overflow-x: hidden;
      }

      html:not(.dark):not(.theme-blue):not(.theme-pink):not(.theme-green) body {
        background-color: #f9fafb !important; /* Force white/light background for light theme */
      }
      .markdown {
        word-break: break-word;
        overflow-wrap: anywhere;
        max-width: 100%;
      }
      /* Attachments container mobile fixes */
      #attachments {
        max-width: 100%;
      }
      #attachments .truncate {
        min-width: 0;
      }
      #attachments .font-medium {
        word-break: break-word;
        overflow-wrap: anywhere;
      }
      #attachments .btnRemove {
        flex-shrink: 0;
      }
      .markdown img {
        max-width: 100%;
        height: auto;
      }
      .markdown table {
        width: 100%;
        display: block;
        overflow-x: auto;
      }
      .markdown pre {
        max-width: 100%;
        overflow: auto;
      }

      /* Attachments list responsive helpers */
      .attachments-item .left {
        min-width: 0;
      }
      .attachments-item .right {
        flex-shrink: 0;
      }
      .fc-face {
        position: absolute;
        inset: 0;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        border-radius: 0.75rem; /* rounded-xl */
        border: 1px solid rgb(229 231 235); /* ring-gray-200 */
        background: white;
        padding: 0.75rem; /* p-3 */
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }
      .dark .fc-face {
        background: #0a0a0a;
        border-color: rgba(255, 255, 255, 0.1);
      }
      .dark .fc-front {
        color: #ffffff;
      }
      .dark .fc-back {
        color: #e5e7eb;
      }
      .fc-front {
        color: rgb(17 24 39); /* gray-900 */
        font-weight: 600;
      }
      .fc-back {
        transform: rotateY(180deg);
        color: rgb(31 41 55); /* gray-800 */
      }
      .fc-hint {
        position: absolute;
        bottom: 0.5rem;
        left: 0.5rem;
        right: 0.5rem;
        font-size: 0.75rem;
        color: rgb(107 114 128); /* gray-500 */
        opacity: 0.85;
      }

      /* Basic markdown rendering */
      .markdown h1,
      .markdown h2,
      .markdown h3 {
        font-weight: 700;
        margin: 0.75rem 0 0.5rem;
      }
      .markdown p {
        margin: 0.5rem 0;
      }
      .markdown ul,
      .markdown ol {
        margin: 0.5rem 1.25rem;
        padding-left: 1rem;
      }
      .markdown code {
        background: #f3f4f6;
        padding: 0.15rem 0.35rem;
        border-radius: 0.25rem;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
      .markdown pre {
        background: #111827;
        color: #e5e7eb;
        padding: 0.75rem;
        border-radius: 0.5rem;
        overflow: auto;
      }
      .markdown blockquote {
        border-left: 4px solid #e5e7eb;
        padding-left: 0.75rem;
        color: #6b7280;
      }
      /* Glass + Chat bubbles + Avatar */
      .avatar {
        width: 28px;
        height: 28px;
        border-radius: 9999px;
        background: rgba(148, 163, 184, 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: rgb(71 85 105);
      }
      .dark .avatar {
        background: rgba(255, 255, 255, 0.08);
        color: rgb(203 213 225);
      }
      .bubble-in {
        background: rgba(255, 255, 255, 0.7);
        color: rgb(15 23 42);
        border: 1px solid rgba(255, 255, 255, 0.25);
      }
      .dark .bubble-in {
        background: rgba(255, 255, 255, 0.06);
        color: rgb(226 232 240);
        border-color: rgba(255, 255, 255, 0.12);
      }
      .bubble-out {
        background: rgba(99, 102, 241, 0.12);
        color: rgb(15 23 42);
        border: 1px solid rgba(99, 102, 241, 0.25);
      }
      .dark .bubble-out {
        background: rgba(99, 102, 241, 0.22);
        color: #fff;
        border-color: rgba(99, 102, 241, 0.35);
      }

      /* Loading skeleton */
      .skeleton {
        position: relative;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.06);
        border-radius: 0.5rem;
        min-height: 2.25rem;
      }
      .dark .skeleton {
        background: rgba(255, 255, 255, 0.06);
      }
      .skeleton::after {
        content: "";
        position: absolute;
        inset: 0;
        transform: translateX(-100%);
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.35),
          transparent
        );
        animation: shimmer 1.2s infinite;
      }
      @keyframes shimmer {
        100% {
          transform: translateX(100%);
        }
      }
      /* Dark brand/text palette to avoid clashes on black */
      .dark .text-primary {
        color: #93c5fd !important;
      } /* sky-300 */
      .dark .text-secondary {
        color: #f9a8d4 !important;
      } /* pink-300 */
      .dark .text-tertiary {
        color: #86efac !important;
      } /* emerald-300 */
      .dark .text-gray-700 {
        color: #cbd5e1 !important;
      } /* slate-300 */
      .dark .text-gray-600 {
        color: #cbd5e1 !important;
      }

      /* Momentum scroll for iOS (applied where supported) */
      @supports (-webkit-overflow-scrolling: touch) {
        .momentum {
          -webkit-overflow-scrolling: touch;
        }
      }

      /* Safe-area insets for iOS notch/home bar */
      :root {
        --safe-top: env(safe-area-inset-top, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-left: env(safe-area-inset-left, 0px);
        --safe-right: env(safe-area-inset-right, 0px);
      }

      /* Sidebar transitions */
      #chatSidebar {
        transition: transform 0.3s ease-out;
        transform: translateX(-100%);
      }
      #chatSidebar.sidebar-open {
        transform: translateX(0);
      }
      #sidebarOverlay {
        transition: opacity 0.3s ease-out;
        opacity: 0;
      }
      #sidebarOverlay.overlay-open {
        opacity: 1;
      }
      :root {
        --mobile-frame-max: 440px;
      }
      /* Limit the app frame width on small screens to simulate modern iPhone width (~440px) */
      @media (max-width: 640px) {
        #appMobileFrame {
          max-width: var(--mobile-frame-max);
          margin-left: auto;
          margin-right: auto;
        }
      }

      /* Enhanced mobile overflow prevention for screens 425px and below */
      @media (max-width: 425px) {
        #appMobileFrame {
          max-width: 100vw;
          width: 100vw;
          margin: 0;
          padding: 0 0.5rem;
          box-sizing: border-box;
        }

        /* Force all containers to respect viewport width */
        .container,
        main,
        header,
        nav,
        section {
          max-width: 100% !important;
          width: 100% !important;
          box-sizing: border-box !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          padding-left: 0.5rem !important;
          padding-right: 0.5rem !important;
        }

        /* Prevent any element from causing horizontal scroll */
        * {
          max-width: 100% !important;
          box-sizing: border-box !important;
        }

        /* Fix header navigation on very small screens */
        header .container {
          padding: 0.75rem 0.5rem !important;
        }

        /* Ensure buttons and inputs don't overflow */
        button,
        input,
        textarea,
        select {
          max-width: 100% !important;
          min-width: 44px !important; /* Minimum touch target */
        }

        /* Fix chat bubbles on very small screens */
        .bubble-in,
        .bubble-out {
          max-width: calc(100vw - 4rem) !important;
          word-break: break-word !important;
          overflow-wrap: break-word !important;
        }

        /* Fix attachments list */
        #attachments {
          word-break: break-all !important;
        }

        /* Fix markdown content */
        .markdown {
          word-break: break-word !important;
          overflow-wrap: break-word !important;
          max-width: 100% !important;
        }

        /* Fix flashcard containers */
        .fc-scene {
          max-width: 100% !important;
        }

        .fc-card {
          max-width: 100% !important;
          height: 10rem !important;
        }

        /* Fix quick menus */
        .quick-menu {
          max-width: calc(100vw - 1rem) !important;
          left: 0.5rem !important;
          right: 0.5rem !important;
        }

        /* Fix tools panel */
        #toolsPanel {
          left: 0.25rem !important;
          right: 0.25rem !important;
          max-width: calc(100vw - 0.5rem) !important;
        }

        /* Fix navigation tabs */
        nav ul {
          gap: 0.25rem !important;
        }

        nav .tab-btn {
          padding: 0.5rem 0.75rem !important;
          font-size: 0.75rem !important;
        }

        /* Fix form elements */
        textarea,
        input[type="text"],
        input[type="number"] {
          font-size: 16px !important; /* Prevent zoom on iOS */
        }
      }

      body {
        padding-left: var(--safe-left);
        padding-right: var(--safe-right);
        padding-bottom: var(--safe-bottom);
      }
      header {
        padding-top: var(--safe-top);
      }
      /* Adjust tools panel top to account for safe-area (mobile and sm+) */
      #toolsPanel {
        top: calc(5rem + var(--safe-top));
      }
      @media (min-width: 640px) {
        #toolsPanel {
          top: calc(6rem + var(--safe-top));
        }
      }

      /* Global focus-visible ring for interactive controls */
      :where(
          a,
          button,
          input,
          textarea,
          select,
          [role="tab"],
          [role="button"]
        ):focus-visible {
        outline: 2px solid #6366f1; /* indigo-500 */
        outline-offset: 2px;
      }

      /* Reduce mobile tap highlight */
      * {
        -webkit-tap-highlight-color: transparent;
      }

      /* Safer modal scrolling for in-place tools panel */
      #toolsPanel {
        touch-action: pan-y;
      }
      @supports (overscroll-behavior: contain) {
        #toolsPanel {
          overscroll-behavior: contain;
        }
      }

      /* Helper for safe bottom padding on scrollable containers */
      .pb-safe {
        padding-bottom: calc(1rem + var(--safe-bottom));
      }

      /* ========== 5-THEME SYSTEM ==========  */

      /* Theme 3: Resistance Blue (Blue Monochromatic) üê¨ */
      .theme-blue {
        --bg-primary: #f0f0ff;
        --bg-secondary: #e6e6ff;
        --text-primary: #080751;
        --text-secondary: #1a18b8;
        --text-muted: #4d4bff;
        --button-primary: #0f0e85;
        --button-primary-hover: #1a18b8;
        --button-secondary: #4d4bff;
        --button-secondary-hover: #a3a2ff;
        --border-color: #a3a2ff;
        --border-subtle: #d0d0ff;
      }

      .theme-blue body {
        background-color: var(--bg-primary) !important;
        color: var(--text-primary);
      }

      .theme-blue .bg-white { background-color: var(--bg-secondary) !important; }
      .theme-blue .bg-gray-50 { background-color: var(--bg-secondary) !important; }
      .theme-blue .text-gray-900 { color: var(--text-primary) !important; }
      .theme-blue .text-gray-700 { color: var(--text-secondary) !important; }
      .theme-blue .text-gray-600 { color: var(--text-secondary) !important; }
      .theme-blue .text-gray-500 { color: var(--text-muted) !important; }
      .theme-blue .border-gray-200 { border-color: var(--border-color) !important; }
      .theme-blue .border-gray-300 { border-color: var(--border-subtle) !important; }
      .theme-blue .bg-primary { background-color: var(--button-primary) !important; color: white !important; }
      .theme-blue .text-primary { color: var(--button-primary) !important; }
      .theme-blue .bg-secondary { background-color: var(--button-secondary) !important; color: white !important; }
      .theme-blue .bg-tertiary { background-color: var(--button-secondary) !important; color: white !important; }
      .theme-blue .hover\:bg-indigo-900:hover { background-color: var(--button-primary-hover) !important; }
      .theme-blue .hover\:bg-green-600:hover { background-color: var(--button-secondary-hover) !important; }
      .theme-blue .hover\:bg-pink-500:hover { background-color: var(--button-secondary-hover) !important; }

      /* Theme 4: Brave Pink (Pink Monochromatic) ü¶© */
      .theme-pink {
        --bg-primary: #fff5fa;
        --bg-secondary: #ffe0f0;
        --text-primary: #8d2d5f;
        --text-secondary: #e44c99;
        --text-muted: #ff69b4;
        --button-primary: #e44c99;
        --button-primary-hover: #ff69b4;
        --button-secondary: #ff69b4;
        --button-secondary-hover: #ffb3d9;
        --border-color: #ffb3d9;
        --border-subtle: #ffe0f0;
      }

      .theme-pink body {
        background-color: var(--bg-primary) !important;
        color: var(--text-primary);
      }

      .theme-pink .bg-white { background-color: var(--bg-secondary) !important; }
      .theme-pink .bg-gray-50 { background-color: var(--bg-secondary) !important; }
      .theme-pink .text-gray-900 { color: var(--text-primary) !important; }
      .theme-pink .text-gray-700 { color: var(--text-secondary) !important; }
      .theme-pink .text-gray-600 { color: var(--text-secondary) !important; }
      .theme-pink .text-gray-500 { color: var(--text-muted) !important; }
      .theme-pink .border-gray-200 { border-color: var(--border-color) !important; }
      .theme-pink .border-gray-300 { border-color: var(--border-subtle) !important; }
      .theme-pink .bg-primary { background-color: var(--button-primary) !important; color: white !important; }
      .theme-pink .text-primary { color: var(--button-primary) !important; }
      .theme-pink .bg-secondary { background-color: var(--button-secondary) !important; color: white !important; }
      .theme-pink .bg-tertiary { background-color: var(--button-secondary) !important; color: white !important; }
      .theme-pink .hover\:bg-indigo-900:hover { background-color: var(--button-primary-hover) !important; }
      .theme-pink .hover\:bg-green-600:hover { background-color: var(--button-secondary-hover) !important; }
      .theme-pink .hover\:bg-pink-500:hover { background-color: var(--button-secondary-hover) !important; }

      /* Theme 5: Hero Green (Green Monochromatic) ü¶ñ */
      .theme-green {
        --bg-primary: #f0fff3;
        --bg-secondary: #e0f5e5;
        --text-primary: #0d3318;
        --text-secondary: #1b612f;
        --text-muted: #2d8f4a;
        --button-primary: #1b612f;
        --button-primary-hover: #2d8f4a;
        --button-secondary: #5cb574;
        --button-secondary-hover: #b8e6c1;
        --border-color: #b8e6c1;
        --border-subtle: #d0f0d5;
      }

      .theme-green body {
        background-color: var(--bg-primary) !important;
        color: var(--text-primary);
      }

      .theme-green .bg-white { background-color: var(--bg-secondary) !important; }
      .theme-green .bg-gray-50 { background-color: var(--bg-secondary) !important; }
      .theme-green .text-gray-900 { color: var(--text-primary) !important; }
      .theme-green .text-gray-700 { color: var(--text-secondary) !important; }
      .theme-green .text-gray-600 { color: var(--text-secondary) !important; }
      .theme-green .text-gray-500 { color: var(--text-muted) !important; }
      .theme-green .border-gray-200 { border-color: var(--border-color) !important; }
      .theme-green .border-gray-300 { border-color: var(--border-subtle) !important; }
      .theme-green .bg-primary { background-color: var(--button-primary) !important; color: white !important; }
      .theme-green .text-primary { color: var(--button-primary) !important; }
      .theme-green .bg-secondary { background-color: var(--button-secondary) !important; color: white !important; }
      .theme-green .bg-tertiary { background-color: var(--button-secondary) !important; color: white !important; }
      .theme-green .hover\:bg-indigo-900:hover { background-color: var(--button-primary-hover) !important; }
      .theme-green .hover\:bg-green-600:hover { background-color: var(--button-secondary-hover) !important; }
      .theme-green .hover\:bg-pink-500:hover { background-color: var(--button-secondary-hover) !important; }

      /* Larger touch targets for tools list items */
      #toolsList .tool-btn {
        min-height: 2.5rem; /* ~40px tap target */
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        border-radius: 0.5rem; /* md */
      }

      /* Compact quick menu for mobile (ChatGPT-like) */
      .quick-menu {
        position: absolute;
        top: 44px; /* just below the + button */
        left: 0;
        z-index: 60;
        width: 220px;
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.9);
        -webkit-backdrop-filter: blur(12px);
        backdrop-filter: blur(12px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      }
      .quick-menu::before {
        content: "";
        position: absolute;
        top: -6px;
        left: 14px; /* arrow aligns under + button */
        width: 10px;
        height: 10px;
        transform: rotate(45deg);
        border-left: 1px solid rgba(255, 255, 255, 0.2);
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        background: inherit;
        -webkit-backdrop-filter: inherit;
        backdrop-filter: inherit;
      }
      .dark .quick-menu {
        background: rgba(0, 0, 0, 0.6);
        border-color: rgba(255, 255, 255, 0.12);
      }
      .quick-item {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        padding: 8px 12px;
        font-size: 0.9rem;
        color: #0f172a; /* slate-900 */
      }
      .quick-item:hover {
        background: rgba(0, 0, 0, 0.04);
      }
      .dark .quick-item {
        color: #e5e7eb; /* gray-200 */
      }
      .dark .quick-item:hover {
        background: rgba(255, 255, 255, 0.08);
      }
    </style>
  </head>
  <body
    class="text-slate-900 dark:text-slate-100 min-h-screen flex flex-col antialiased selection:bg-indigo-500/20 selection:text-indigo-900 dark:selection:text-white"
  >
    <div id="appMobileFrame">
      <!-- Header -->
      <header
        class="sticky top-0 z-40 bg-primary text-white dark:bg-black border-b border-white/20 dark:border-white/10 ring-1 ring-black/5 shadow-lg"
      >
        <div
          class="container mx-auto max-w-6xl px-4 py-4 flex items-center justify-between"
        >
          <div class="flex items-center gap-3">
            <!-- Sidebar Toggle (only for authenticated users) -->
            <button
              id="sidebarToggle"
              class="userOnlyLink hidden flex items-center justify-center w-8 h-8 rounded-md hover:bg-white/10 transition-colors"
              title="Toggle chat history"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
            
            <a href="/" class="text-xl sm:text-2xl font-bold tracking-tight"
              >ILMATRIX</a
            >
          </div>
          <div class="flex items-center gap-2">
            <nav class="hidden sm:flex items-center gap-2">
              <a
                href="/app"
                class="text-xs sm:text-sm px-3 py-2 rounded-md hover:bg-indigo-900"
                >App</a
              >
              <a
                href="/about"
                class="text-xs sm:text-sm px-3 py-2 rounded-md hover:bg-indigo-900"
                >About</a
              >
            </nav>
            <div class="flex items-center gap-2">
              <!-- Guest Usage Counter (shown for guest users) -->
              <div id="guestUsageCounter" class="hidden items-center gap-2 px-2 py-1 bg-orange-600/80 rounded-md text-xs">
                <svg class="w-3 h-3 text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span id="guestUsageText" class="text-white font-medium">0/5 uses</span>
              </div>
              
              <!-- User Info (shown when logged in) -->
              <div id="userInfo" class="hidden items-center gap-2">
                <!-- User Dropdown -->
                <div class="relative">
                  <button 
                    id="userDropdownBtn"
                    class="flex items-center gap-2 text-xs sm:text-sm text-white/90 hover:text-white transition-colors px-2 py-1 rounded-md hover:bg-white/10"
                    aria-expanded="false"
                  >
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                    </svg>
                    <span id="userName"></span>
                    <svg class="w-3 h-3 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 9-7 7-7-7"></path>
                    </svg>
                  </button>
                  
                  <!-- Dropdown Menu -->
                  <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-48 bg-gray-50 dark:bg-black rounded-md shadow-lg ring-1 ring-gray-200 dark:ring-white/10 z-50">
                    <div class="py-1">
                      <a href="/dashboard" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-800">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                        </svg>
                        Dashboard
                      </a>
                      <a href="/profile" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-800">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Profile Settings
                      </a>
                      <div class="border-t border-gray-200 dark:border-white/10"></div>
                      <button
                        id="btnLogout"
                        class="flex items-center gap-2 w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-800"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        Logout
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Login button (shown when not logged in) -->
              <a
                id="btnLogin"
                href="/login"
                class="text-xs sm:text-sm bg-green-600 hover:bg-green-700 transition text-white px-3 py-2 rounded-md"
              >
                Login
              </a>
              
              <button
                id="btnHealth"
                class="text-xs sm:text-sm bg-secondary hover:bg-pink-500 transition text-white px-3 py-2 rounded-md"
              >
                Check API
              </button>
              <button
                id="btnTheme"
                class="inline-flex items-center gap-1.5 text-xs sm:text-sm px-3 py-2 rounded-xl border border-white/30 ring-1 ring-black/5 bg-white/80 hover:bg-white/90 text-slate-900 shadow-sm transition-all duration-200 ease-out dark:bg-slate-800/80 dark:hover:bg-slate-800 dark:text-slate-100"
                title="Toggle theme"
                aria-label="Toggle theme"
              >
                <span
                  class="icon-sun text-yellow-500 dark:hidden"
                  aria-hidden="true"
                  >‚òÄÔ∏è</span
                >
                <span
                  class="icon-moon hidden dark:inline text-slate-100"
                  aria-hidden="true"
                  >üåï</span
                >
                Theme
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Chat History Sidebar -->
      <div id="chatSidebar" class="hidden fixed left-0 top-0 h-full w-full sm:w-80 max-w-sm bg-gray-50 dark:bg-black border-r border-gray-200 dark:border-white/10 z-50 flex flex-col shadow-2xl">
        <!-- Sidebar Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-white/10">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Chat History</h2>
          <button id="closeSidebar" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <!-- New Chat Button -->
        <div class="p-4 border-b border-gray-200 dark:border-white/10">
          <button id="newChatBtn" class="w-full flex items-center gap-2 px-3 py-2 bg-tertiary hover:bg-green-600 text-white rounded-md transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            New Chat
          </button>
        </div>
        
        <!-- Chat Sessions List -->
        <div class="flex-1 overflow-y-auto">
          <div id="chatSessionsList" class="p-2">
            <!-- Sessions will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Sidebar Overlay -->
      <div id="sidebarOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>

      <!-- Nav -->
      <nav
        class="hidden sticky top-14 sm:top-16 z-30 bg-white/10 dark:bg-white/5 backdrop-blur-md border-b border-white/20 ring-1 ring-black/5"
      >
        <div class="container mx-auto max-w-6xl px-4 overflow-x-auto">
          <ul class="flex gap-2 sm:gap-3 py-2 text-sm">
            <li>
              <button
                data-tab="chat"
                class="tab-btn px-3 py-2 rounded-md bg-primary text-white hover:bg-indigo-900"
              >
                Chat
              </button>
            </li>
            <li>
              <button
                data-tab="upload"
                class="tab-btn px-3 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
              >
                Upload
              </button>
            </li>
            <li>
              <button
                data-tab="explain"
                class="tab-btn px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
              >
                Explain
              </button>
            </li>
            <li>
              <button
                data-tab="quiz"
                class="tab-btn px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
              >
                Quiz
              </button>
            </li>
            <li>
              <button
                data-tab="forum"
                class="tab-btn px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
              >
                Forum
              </button>
            </li>
            <li>
              <button
                data-tab="exam"
                class="tab-btn px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
              >
                Exam
              </button>
            </li>
            <li>
              <button
                data-tab="flashcards"
                class="tab-btn px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
              >
                Flashcards
              </button>
            </li>
            <li>
              <button
                data-tab="dialogue"
                class="tab-btn px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
              >
                Dialogue
              </button>
            </li>
          </ul>
        </div>
      </nav>

      <!-- Main -->
      <main
        class="container mx-auto max-w-7xl px-4 py-6 space-y-6 flex-1 pb-safe"
      >
        <!-- Chat (General) -->
        <section
          id="sec-chat"
          class="card bg-white dark:bg-neutral-900 rounded-xl shadow-sm ring-1 ring-gray-200 dark:ring-white/10"
        >
          <div class="p-5 sm:p-6">
            <h2 class="text-lg sm:text-xl font-semibold text-primary mb-4">
              Chat
            </h2>
            <div class="relative">
              <div
                id="chat"
                role="log"
                aria-live="polite"
                aria-relevant="additions text"
                class="w-full rounded-2xl border border-white/20 dark:border-white/10 ring-1 ring-black/5 bg-white/40 dark:bg-neutral-900 backdrop-blur-md p-4 sm:p-5 min-h-[200px] max-h-[500px] overflow-auto momentum text-sm transition-all duration-200 ease-out"
              ></div>
              <div
                id="activeToolBadge"
                class="hidden absolute bottom-2 left-2 z-10 shrink-0 items-center gap-1 px-2 py-1 rounded-md border border-white/20 ring-1 ring-black/5 bg-white/70 dark:bg-white/10 text-slate-900 dark:text-slate-100 text-xs"
              >
                <span id="activeToolLabel">Explain</span>
                <button
                  id="activeToolClear"
                  class="ml-1 inline-flex items-center justify-center w-4 h-4 rounded hover:bg-black/5 dark:hover:bg-white/10"
                  title="Clear tool"
                  aria-label="Clear tool"
                >
                  &times;
                </button>
              </div>
            </div>
            <div
              id="attachmentsBar"
              class="hidden mt-2 flex items-center justify-between gap-3 rounded-lg border border-white/20 ring-1 ring-black/5 bg-white/60 dark:bg-white/10 px-3 py-2 text-xs"
            >
              <div class="truncate">
                <span
                  class="text-gray-700 dark:text-slate-300"
                  id="attachmentsSummary"
                ></span>
              </div>
              <button
                id="btnClearAttachments"
                class="shrink-0 inline-flex items-center gap-1 px-2 py-1 rounded-md border border-red-300 dark:border-red-500/40 bg-white dark:bg-neutral-900 text-red-700 dark:text-red-300 hover:bg-red-50 dark:hover:bg-white/10"
                title="Remove all files from current material"
              >
                Remove all
              </button>
            </div>
            <div class="mt-3 flex gap-2 items-start relative">
              <!-- Quick actions (+) with in-place tools panel -->
              <div class="relative">
                <button
                  id="btnActionMenu"
                  class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-gray-300 dark:border-white/20 bg-white dark:bg-neutral-900 text-gray-700 dark:text-slate-100 hover:bg-gray-50 dark:hover:bg-white/10 select-none"
                  title="Open tools"
                  aria-label="Open tools"
                  aria-haspopup="menu"
                  aria-controls="quickMenu"
                  aria-expanded="false"
                >
                  +
                </button>

                <!-- Mobile quick menu (ChatGPT-like), shown only on small screens -->
                <div
                  id="quickMenu"
                  class="hidden quick-menu"
                  role="menu"
                  aria-label="Quick actions"
                >
                  <div class="p-1">
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="upload"
                    >
                      ‚ûï Add files
                    </button>
                    <div class="h-px my-1 bg-black/10 dark:bg-white/10"></div>
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="explain"
                    >
                      üß† Explain
                    </button>
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="quiz"
                    >
                      ‚ùì Quiz
                    </button>
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="forum"
                    >
                      üí¨ Forum
                    </button>
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="exam"
                    >
                      üìù Exam
                    </button>
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="flashcards"
                    >
                      üÉè Cards
                    </button>
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="dialogue"
                    >
                      üéØ Dialogue
                    </button>
                  </div>
                </div>

                <!-- In-place tools panel (no navigation) -->
                <div
                  id="toolsPanel"
                  class="hidden fixed top-20 sm:top-24 inset-x-4 sm:inset-x-8 z-50 w-auto max-w-screen-xl mx-auto max-h-[80vh] overflow-auto momentum rounded-2xl border border-white/20 dark:border-white/10 ring-1 ring-black/5 bg-white/60 dark:bg-black backdrop-blur-xl shadow-2xl"
                  role="dialog"
                  aria-modal="true"
                  aria-label="Study tools"
                >
                  <div class="p-3 panel-inner pb-safe">
                    <div class="flex gap-3">
                      <!-- Tools list -->
                      <div class="w-28 shrink-0">
                        <ul
                          id="toolsList"
                          class="space-y-1 text-sm"
                          role="tablist"
                          aria-label="Study tools"
                          aria-orientation="vertical"
                        >
                          <li role="presentation">
                            <button
                              id="tab-upload"
                              role="tab"
                              aria-selected="true"
                              tabindex="0"
                              class="tool-btn w-full text-left px-3 py-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-white/10 hover:text-slate-900 dark:hover:text-slate-100 focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-black outline-none"
                              data-tool="upload"
                            >
                              Upload
                            </button>
                          </li>
                          <li role="presentation">
                            <button
                              id="tab-explain"
                              role="tab"
                              aria-selected="false"
                              tabindex="-1"
                              class="tool-btn w-full text-left px-3 py-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-white/10 hover:text-slate-900 dark:hover:text-slate-100 focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-black outline-none"
                              data-tool="explain"
                            >
                              Explain
                            </button>
                          </li>
                          <li role="presentation">
                            <button
                              id="tab-quiz"
                              role="tab"
                              aria-selected="false"
                              tabindex="-1"
                              class="tool-btn w-full text-left px-3 py-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-white/10 hover:text-slate-900 dark:hover:text-slate-100 focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-black outline-none"
                              data-tool="quiz"
                            >
                              Quiz
                            </button>
                          </li>
                          <li role="presentation">
                            <button
                              id="tab-forum"
                              role="tab"
                              aria-selected="false"
                              tabindex="-1"
                              class="tool-btn w-full text-left px-3 py-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-white/10 hover:text-slate-900 dark:hover:text-slate-100 focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-black outline-none"
                              data-tool="forum"
                            >
                              Forum
                            </button>
                          </li>
                          <li role="presentation">
                            <button
                              id="tab-exam"
                              role="tab"
                              aria-selected="false"
                              tabindex="-1"
                              class="tool-btn w-full text-left px-3 py-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-white/10 hover:text-slate-900 dark:hover:text-slate-100 focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-black outline-none"
                              data-tool="exam"
                            >
                              Exam
                            </button>
                          </li>
                          <li role="presentation">
                            <button
                              id="tab-flashcards"
                              role="tab"
                              aria-selected="false"
                              tabindex="-1"
                              class="tool-btn w-full text-left px-3 py-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-white/10 hover:text-slate-900 dark:hover:text-slate-100 focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-black outline-none"
                              data-tool="flashcards"
                            >
                              Flashcards
                            </button>
                          </li>
                          <li role="presentation">
                            <button
                              id="tab-dialogue"
                              role="tab"
                              aria-selected="false"
                              tabindex="-1"
                              class="tool-btn w-full text-left px-3 py-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-white/10 hover:text-slate-900 dark:hover:text-slate-100 focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-black outline-none"
                              data-tool="dialogue"
                            >
                              Dialogue
                            </button>
                          </li>
                        </ul>
                      </div>
                      <!-- Dynamic content host (feature sections will be moved here at first open) -->
                      <div
                        id="toolsContent"
                        class="flex-1 min-w-0 space-y-2"
                      ></div>
                    </div>
                  </div>
                </div>
                <div
                  id="toolsBackdrop"
                  class="hidden fixed inset-0 z-40 bg-slate-900/30 dark:bg-black/60"
                ></div>
              </div>
              <textarea
                id="chatInput"
                rows="4"
                placeholder="Write here..."
                aria-label="Chat input"
                class="flex-1 rounded-xl border border-white/20 ring-1 ring-black/5 bg-white px-4 py-3 text-[16px] leading-relaxed font-medium text-black placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-neutral-900 dark:text-white dark:placeholder-slate-400 transition-all duration-200 ease-out min-h-[100px]"
              ></textarea>
              <button
                id="btnSend"
                class="inline-flex items-center justify-center px-4 py-2 rounded-md bg-tertiary text-white font-medium hover:bg-green-600 transition"
              >
                Send
              </button>
            </div>
          </div>
        </section>

        <!-- Upload -->
        <section
          id="sec-upload"
          class="card rounded-2xl border border-white/20 ring-1 ring-black/5 bg-white/40 dark:bg-white/5 backdrop-blur-md shadow-sm"
        >
          <div class="p-5 sm:p-6">
            <h2 class="text-lg sm:text-xl font-semibold text-primary mb-4">
              Upload Material (PDF / TXT / PNG / JPG / DOCX / PPTX)
            </h2>

            <!-- Header bar: current material + actions -->
            <div class="flex flex-wrap items-center gap-3 mb-3">
              <div class="text-sm text-gray-700 dark:text-slate-300">
                Current material:
                <span
                  id="currentMaterialLabel"
                  class="font-semibold text-primary"
                  >none</span
                >
              </div>
              <button
                id="btnNewMaterial"
                class="px-3 py-1.5 rounded-md border border-gray-300 dark:border-white/20 text-sm bg-white dark:bg-neutral-900 dark:text-white hover:bg-gray-50 dark:hover:bg-white/10"
                title="Start a new material (does not delete existing one)"
              >
                Start new material
              </button>
              <span
                id="uploadInfo"
                class="text-sm text-gray-600 dark:text-slate-400"
              ></span>
            </div>

            <!-- Hidden multi-file picker (triggered by clicking the drop zone) -->
            <input
              id="filePicker"
              class="hidden"
              type="file"
              multiple
              aria-label="Select files"
              accept=".pdf,.txt,.png,.jpg,.jpeg,.docx,.pptx,image/*,application/pdf,text/plain,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.presentationml.presentation"
            />

            <!-- Drop zone (click or drag & drop) -->
            <div
              id="dropZone"
              class="rounded-lg border-2 border-dashed border-gray-300 dark:border-white/10 bg-white/60 dark:bg-white/10 hover:bg-white/80 dark:hover:bg-white/15 backdrop-blur transition p-4 sm:p-6 text-center cursor-pointer"
              role="button"
              tabindex="0"
              aria-label="Drop files here or click to select"
            >
              <p class="font-medium text-gray-800 dark:text-slate-200">
                Drag & drop files here
              </p>
              <p class="text-xs text-gray-500 dark:text-slate-400">
                or click to select. Accepted: PDF, TXT, PNG/JPG, DOCX, PPTX.
                Total limit 10 MB per material.
              </p>
            </div>

            <!-- Attachments list -->
            <div id="attachments" class="mt-4 grid gap-2">
              <em class="text-gray-500 dark:text-slate-400"
                >No files yet. Drop or click to upload.</em
              >
            </div>
          </div>
        </section>

        <!-- Explain -->
        <section
          id="sec-explain"
          class="card hidden bg-white dark:bg-neutral-900 rounded-xl shadow-sm ring-1 ring-gray-200 dark:ring-white/10"
        >
          <div class="p-5 sm:p-6">
            <h2 class="text-lg sm:text-xl font-semibold text-primary mb-4">
              Explain Material
            </h2>
            <label
              for="promptExplain"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Prompt / Notes</label
            >
            <textarea
              id="promptExplain"
              rows="4"
              class="w-full rounded-xl border border-white/20 ring-1 ring-black/5 px-4 py-3 text-base font-medium text-black placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white dark:bg-neutral-900 dark:text-white dark:placeholder-slate-400 transition-all duration-200 ease-out"
              placeholder="Explain chapter 2... explain with tables and examples..."
            ></textarea>
            <div class="mt-3">
              <button
                id="btnExplain"
                class="px-4 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
              >
                Run Explain
              </button>
            </div>
            <div
              id="explainResult"
              class="mt-4 text-sm bg-gray-50 dark:bg-neutral-900 border border-gray-200 dark:border-white/10 rounded-md p-3 whitespace-pre-wrap break-words overflow-x-auto"
            ></div>
          </div>
        </section>

        <!-- Quiz (Merged: generate + answer + grade) -->
        <section
          id="sec-quiz"
          class="card hidden bg-white dark:bg-neutral-900 rounded-xl shadow-sm ring-1 ring-gray-200 dark:ring-white/10"
        >
          <div class="p-5 sm:p-6 space-y-4">
            <h2 class="text-lg sm:text-xl font-semibold text-primary mb-2">
              Quiz (MCQ) ‚Äî Generate ‚Ä¢ Answer ‚Ä¢ Grade
            </h2>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="flex flex-col">
                <label
                  for="numQuestions"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Number of questions</label
                >
                <input
                  id="numQuestions"
                  type="number"
                  min="1"
                  max="20"
                  value="5"
                  class="w-full rounded-md border border-gray-300 dark:border-white/10 px-3 py-2 text-sm bg-white dark:bg-neutral-900 text-gray-900 dark:text-white"
                  placeholder="5"
                  aria-label="Number of generated quiz questions"
                />
              </div>
              <div class="flex items-end">
                <button
                  id="btnGenerateQuizMCQ"
                  class="px-4 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
                >
                  Generate MCQ
                </button>
              </div>
            </div>

            <div id="quizMCQ" class="space-y-4"></div>

            <div class="space-y-2">
              <label
                for="quizAnswers"
                class="block text-sm font-medium text-gray-700"
                >Your Answers (format per line: 1 a, 2 b, ...)</label
              >
              <textarea
                id="quizAnswers"
                rows="4"
                class="w-full rounded-xl border border-white/20 ring-1 ring-black/5 px-4 py-3 text-base font-medium text-black placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white dark:bg-neutral-900 dark:text-white dark:placeholder-slate-400 transition-all duration-200 ease-out"
                placeholder="1 a&#10;2 b&#10;3 c&#10;4 d&#10;5 e"
              ></textarea>
              <div>
                <button
                  id="btnSubmitQuizMCQ"
                  class="px-4 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
                >
                  Submit & Grade
                </button>
              </div>
            </div>

            <div
              id="quizResult"
              class="text-sm bg-gray-50 dark:bg-neutral-900 border border-gray-200 dark:border-white/10 rounded-md p-3 whitespace-pre-wrap break-words overflow-x-auto"
            ></div>
          </div>
        </section>

        <!-- Forum -->
        <section
          id="sec-forum"
          class="card hidden bg-white dark:bg-neutral-900 rounded-xl shadow-sm ring-1 ring-gray-200 dark:ring-white/10"
        >
          <div class="p-5 sm:p-6">
            <h2 class="text-lg sm:text-xl font-semibold text-primary mb-4">
              Forum Reply
            </h2>
            <label
              for="promptForum"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Prompt</label
            >
            <textarea
              id="promptForum"
              rows="4"
              class="w-full rounded-xl border border-white/20 ring-1 ring-black/5 px-4 py-3 text-base font-medium text-black placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white dark:bg-neutral-900 dark:text-white dark:placeholder-slate-400 transition-all duration-200 ease-out"
              placeholder="Questions/Forum topics..."
            ></textarea>
            <div class="mt-3">
              <button
                id="btnForum"
                class="px-4 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
              >
                Draft Reply
              </button>
            </div>
            <div
              id="forumResult"
              class="mt-4 text-sm bg-gray-50 dark:bg-neutral-900 border border-gray-200 dark:border-white/10 rounded-md p-3 whitespace-pre-wrap break-words overflow-x-auto"
            ></div>
          </div>
        </section>

        <!-- Exam -->
        <section
          id="sec-exam"
          class="card hidden bg-white dark:bg-neutral-900 rounded-xl shadow-sm ring-1 ring-gray-200 dark:ring-white/10"
        >
          <div class="p-5 sm:p-6">
            <h2 class="text-lg sm:text-xl font-semibold text-primary mb-4">
              Exam Helper
            </h2>
            <label
              for="promptExam"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Prompt</label
            >
            <textarea
              id="promptExam"
              rows="4"
              class="w-full rounded-xl border border-white/20 ring-1 ring-black/5 px-4 py-3 text-base font-medium text-black placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white dark:bg-neutral-900 dark:text-white dark:placeholder-slate-400 transition-all duration-200 ease-out"
              placeholder="Exam-related instructions/questions..."
            ></textarea>
            <div class="mt-3">
              <button
                id="btnExam"
                class="px-4 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
              >
                Run Exam Helper
              </button>
            </div>
            <div
              id="examResult"
              class="mt-4 text-sm bg-gray-50 dark:bg-neutral-900 border border-gray-200 dark:border-white/10 rounded-md p-3 whitespace-pre-wrap break-words overflow-x-auto"
            ></div>
          </div>
        </section>

        <!-- Flashcards -->
        <section
          id="sec-flashcards"
          class="card hidden bg-white dark:bg-neutral-900 rounded-xl shadow-sm ring-1 ring-gray-200 dark:ring-white/10"
        >
          <div class="p-5 sm:p-6 space-y-4">
            <h2 class="text-lg sm:text-xl font-semibold text-primary">
              Flashcards
            </h2>

            <div class="flex flex-wrap gap-3 items-end">
              <div>
                <label for="numCards" class="block text-xs text-gray-600"
                  >Number of flashcards</label
                >
                <input
                  id="numCards"
                  type="number"
                  min="1"
                  max="50"
                  value="5"
                  class="w-28 rounded-md border border-gray-300 dark:border-white/10 px-2 py-2 text-sm bg-white dark:bg-neutral-900 text-gray-900 dark:text-white"
                  placeholder="5"
                  aria-label="Number of flashcards"
                />
              </div>
              <button
                id="btnGenerateCards"
                class="px-3 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
              >
                Generate Flashcards
              </button>
            </div>

            <div
              id="flashcardsList"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
            ></div>
          </div>
        </section>
        <!-- Dialogue -->
        <section
          id="sec-dialogue"
          class="card hidden bg-white dark:bg-neutral-900 rounded-xl shadow-sm ring-1 ring-gray-200 dark:ring-white/10"
        >
          <div class="p-5 sm:p-6">
            <div class="flex items-start justify-between gap-2">
              <h2 class="text-lg sm:text-xl font-semibold text-primary">
                Dialogue
              </h2>
              <button
                id="btnDialogueHint"
                class="hidden text-xs sm:text-sm border border-gray-300 px-3 py-1.5 rounded-md hover:bg-gray-50"
                title="Get a hint for the current topic"
              >
                I'm stuck
              </button>
            </div>

            <p class="text-sm text-gray-600 mt-1">
              Guided, topic-based coaching grounded in your uploaded material.
            </p>

            <div class="mt-4 flex items-center gap-3">
              <button
                id="btnDialogueStart"
                class="px-3 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
              >
                Start
              </button>
              <button
                id="btnDialogueBegin"
                class="hidden px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
              >
                Let's get started!
              </button>
            </div>

            <div
              id="dialogueStream"
              role="log"
              aria-live="polite"
              aria-relevant="additions text"
              class="mt-4 text-sm bg-gray-50 dark:bg-neutral-900 border border-gray-200 dark:border-white/10 rounded-md p-3 markdown"
            >
              <em class="text-gray-500">Click Start to begin Dialogue.</em>
            </div>

            <div class="mt-3 flex gap-2 items-start">
              <!-- Mobile-only inline quick (+) for Dialogue -->
              <div class="relative sm:hidden">
                <button
                  id="btnActionMenuDialogue"
                  class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-gray-300 dark:border-white/20 bg-white dark:bg-neutral-900 text-gray-700 dark:text-slate-100 hover:bg-gray-50 dark:hover:bg-white/10 select-none"
                  title="Open tools"
                  aria-label="Open tools"
                  aria-haspopup="menu"
                  aria-controls="quickMenuDialogue"
                  aria-expanded="false"
                >
                  +
                </button>

                <!-- Local quick menu anchored to the inline + (mobile) -->
                <div
                  id="quickMenuDialogue"
                  class="hidden quick-menu"
                  role="menu"
                  aria-label="Quick actions"
                >
                  <div class="p-1">
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="upload"
                    >
                      ‚ûï Add files
                    </button>
                    <div class="h-px my-1 bg-black/10 dark:bg-white/10"></div>
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="explain"
                    >
                      üß† Explain
                    </button>
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="quiz"
                    >
                      ‚ùì Quiz
                    </button>
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="forum"
                    >
                      üí¨ Forum
                    </button>
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="exam"
                    >
                      üìù Exam
                    </button>
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="flashcards"
                    >
                      üÉè Cards
                    </button>
                    <button
                      class="quick-item rounded-md"
                      role="menuitem"
                      tabindex="-1"
                      data-menu="dialogue"
                    >
                      üéØ Dialogue
                    </button>
                  </div>
                </div>
              </div>

              <textarea
                id="dialogueInput"
                class="flex-1 rounded-xl border border-white/20 ring-1 ring-black/5 bg-white px-4 py-3 text-base font-medium text-black placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-neutral-900 dark:text-white dark:placeholder-slate-400 transition-all duration-200 ease-out min-h-[52px]"
                rows="2"
                placeholder="Type your answer (tip: ask 'How am I doing?')"
              ></textarea>
              <button
                id="btnDialogueSend"
                class="px-4 py-2 rounded-md bg-primary text-white font-medium hover:bg-indigo-900 disabled:opacity-50"
                disabled
              >
                Send
              </button>
            </div>
          </div>
        </section>
      </main>

      <footer class="border-t border-gray-200 dark:border-white/10">
        <div
          class="container mx-auto max-w-6xl px-4 py-6 text-xs text-gray-500"
        >
          Theme colors:
          <span class="font-medium" style="color: #0f0e85;">üê¨ Resistance Blue</span> ¬∑
          <span class="font-medium" style="color: #e44c99;">ü¶© Brave Pink</span> ¬∑
          <span class="font-medium" style="color: #1b612f;">ü¶ñ Hero Green</span>
        </div>
        <div
          class="container mx-auto max-w-6xl px-4 py-6 text-xs text-gray-500"
        >
          <p>Made with ‚ù§Ô∏è by ILMATRIX</p>
        </div>
      </footer>

      <!-- Global mobile floating quick action (+) -->
      <div
        id="globalQuickMenuWrap"
        class="hidden sm:hidden fixed bottom-16 left-4 z-50"
      >
        <div class="relative">
          <button
            id="btnActionMenuGlobal"
            class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-gray-300 dark:border-white/20 bg-white dark:bg-neutral-900 text-gray-700 dark:text-slate-100 hover:bg-gray-50 dark:hover:bg-white/10 select-none"
            title="Open tools"
            aria-label="Open tools"
            aria-haspopup="menu"
            aria-controls="quickMenuGlobal"
            aria-expanded="false"
          >
            +
          </button>

          <div
            id="quickMenuGlobal"
            class="hidden quick-menu"
            role="menu"
            aria-label="Quick actions"
          >
            <div class="p-1">
              <button
                class="quick-item rounded-md"
                role="menuitem"
                tabindex="-1"
                data-menu="upload"
              >
                ‚ûï Add files
              </button>
              <div class="h-px my-1 bg-black/10 dark:bg-white/10"></div>
              <button
                class="quick-item rounded-md"
                role="menuitem"
                tabindex="-1"
                data-menu="explain"
              >
                üß† Explain
              </button>
              <button
                class="quick-item rounded-md"
                role="menuitem"
                tabindex="-1"
                data-menu="quiz"
              >
                ‚ùì Quiz
              </button>
              <button
                class="quick-item rounded-md"
                role="menuitem"
                tabindex="-1"
                data-menu="forum"
              >
                üí¨ Forum
              </button>
              <button
                class="quick-item rounded-md"
                role="menuitem"
                tabindex="-1"
                data-menu="exam"
              >
                üìù Exam
              </button>
              <button
                class="quick-item rounded-md"
                role="menuitem"
                tabindex="-1"
                data-menu="flashcards"
              >
                üÉè Cards
              </button>
              <button
                class="quick-item rounded-md"
                role="menuitem"
                tabindex="-1"
                data-menu="dialogue"
              >
                üéØ Dialogue
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // State
      let materialId = null;
      let sessionId = null;
      let chat = [];
      let mcqQuestions = [];
      // Active tool routing for mobile-first UX ("chat" by default)
      let activeTool = "chat";

      // MaterialId persistence functions
      function saveMaterialId(newId) {
        const oldId = materialId;
        materialId = newId;
        try {
          if (newId) {
            localStorage.setItem("ilmatrix_materialId", newId);
            // Load chat history for this material
            if (newId !== oldId) {
              loadChatHistory(newId);
              renderChat();
            }
          } else {
            localStorage.removeItem("ilmatrix_materialId");
            // Clear chat when no material
            chat = [];
            renderChat();
          }
        } catch (e) {
          console.warn("Failed to save materialId to localStorage:", e);
        }
      }

      function loadMaterialId() {
        try {
          const saved = localStorage.getItem("ilmatrix_materialId");
          if (saved) {
            materialId = saved;
            return saved;
          }
        } catch (e) {
          console.warn("Failed to load materialId from localStorage:", e);
        }
        return null;
      }

      async function verifyMaterialExists(id) {
        if (!id) return false;
        try {
          const res = await fetch(`/api/material/${id}`);
          if (res.ok) {
            const data = await res.json();
            return data && data.files && data.files.length > 0;
          }
        } catch (e) {
          console.warn("Failed to verify material exists:", e);
        }
        return false;
      }

      // Chat history persistence functions
      async function saveChatHistory() {
        try {
          if (chat.length > 0 && !sessionId) {
            // Only save to localStorage if we don't have an active session
            localStorage.setItem("ilmatrix_chat_global", JSON.stringify(chat));

            // Also save per-material if materialId exists
            if (materialId) {
              const key = `ilmatrix_chat_${materialId}`;
              localStorage.setItem(key, JSON.stringify(chat));
            }
          }
        } catch (e) {
          console.warn("Failed to save chat history:", e);
        }
      }
      
      // Save chat message to session on server
      async function saveChatMessageToSession(role, content, endpoint = null) {
        if (!sessionId) return;
        
        try {
          // Save message to server
          await fetch(`/api/dashboard/chat/sessions/${sessionId}/messages`, {
            method: 'POST',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              role: role,
              content: content,
              materialId: materialId,
              endpoint: endpoint
            })
          });
        } catch (error) {
          console.error('Failed to save message to session:', error);
        }
      }

      // Reset all session-related state
      function resetSessionState() {
        console.log('[Session Reset] Starting state reset...');
        console.log('[Session Reset] Before - materialId:', materialId, 'chat length:', chat.length);

        // Clear chat messages
        chat = [];

        // Clear material ID (CRITICAL FIX: prevents material bleeding between sessions)
        materialId = null;
        localStorage.removeItem("ilmatrix_materialId");

        // Clear MCQ questions
        mcqQuestions = [];

        // Reset active tool to chat
        activeTool = "chat";

        // Reset dialogue state (if exists)
        if (typeof resetDialogueUI === 'function') {
          try {
            resetDialogueUI();
          } catch (e) {
            console.warn('Failed to reset dialogue UI:', e);
          }
        }

        // Clear UI elements
        const currentMaterialLabel = $("currentMaterialLabel");
        if (currentMaterialLabel) {
          currentMaterialLabel.textContent = "none";
        }

        const attachmentsBar = $("attachmentsBar");
        if (attachmentsBar) {
          attachmentsBar.classList.add("hidden");
        }

        const attachments = $("attachments");
        if (attachments) {
          attachments.innerHTML = '<em class="text-gray-500 dark:text-slate-400">No files yet. Drop or click to upload.</em>';
        }

        // Clear all result areas
        const resultAreas = ['explainResult', 'quizMCQ', 'quizResult', 'forumResult', 'examResult'];
        resultAreas.forEach(id => {
          const el = $(id);
          if (el) el.innerHTML = '';
        });

        // Clear flashcards container
        const flashcardsContainer = $("flashcardsContainer");
        if (flashcardsContainer) {
          flashcardsContainer.innerHTML = '';
        }

        // Update UI
        updateActiveToolBadge();
        setComposerPlaceholder();
        renderChat();

        console.log('[Session Reset] After - materialId:', materialId, 'chat length:', chat.length);
        console.log('[Session Reset] State reset complete');
      }

      // Load chat session from server
      async function loadChatSession(sessionIdParam) {
        console.log('[Load Session] Loading session:', sessionIdParam);
        try {
          // CRITICAL FIX: Reset all state before loading new session
          // This prevents material/chat bleeding between sessions
          resetSessionState();

          sessionId = sessionIdParam;

          // Get session messages from server
          const response = await fetch(`/api/dashboard/chat/sessions/${sessionId}/messages`, {
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error('Failed to load session');
          }

          const data = await response.json();

          // CRITICAL FIX: Extract materialId BEFORE converting to chat format
          // Get the most recent materialId from server messages
          const messagesWithMaterial = data.messages.filter(msg => msg.materialId);
          let lastMaterialId = null;
          if (messagesWithMaterial.length > 0) {
            lastMaterialId = messagesWithMaterial[messagesWithMaterial.length - 1].materialId;
          }

          // Convert server messages to chat format
          // IMPORTANT: Only include role and content (required by API)
          // Do NOT include extra fields like materialId, timestamp, etc.
          chat = data.messages.map(msg => ({
            role: msg.role,
            content: msg.content
          }));

          // CRITICAL FIX: Load the materialId associated with this session
          if (lastMaterialId) {
            console.log('[Load Session] Found materialId in messages:', lastMaterialId);

            // Verify this material still exists before loading
            const materialExists = await verifyMaterialExists(lastMaterialId);
            console.log('[Load Session] Material exists:', materialExists);

            if (materialExists) {
              // Load the material associated with this session
              materialId = lastMaterialId;
              localStorage.setItem("ilmatrix_materialId", materialId);
              console.log('[Load Session] Loaded materialId:', materialId);

              // Fetch and display material info
              try {
                const matRes = await fetch(`/api/material/${materialId}`);
                if (matRes.ok) {
                  const matData = await matRes.json();
                  updateMaterialUI(matData);
                  console.log('[Load Session] Material UI updated');
                }
              } catch (e) {
                console.warn('Failed to load material info:', e);
              }
            }
          } else {
            console.log('[Load Session] No materialId found in messages');
          }

          // Update URL without reloading page
          const url = new URL(window.location);
          url.searchParams.set('sessionId', sessionId);
          window.history.replaceState(null, '', url);

          renderChat();

          // Close sidebar after loading session (better UX)
          if (chatSidebar) {
            chatSidebar.close();
          }

          console.log('[Load Session] Session loaded successfully');
          console.log('[Load Session] Final state - sessionId:', sessionId, 'materialId:', materialId, 'messages:', chat.length);

          return true;
        } catch (error) {
          console.error('[Load Session] Failed to load chat session:', error);
          resetSessionState();
          return false;
        }
      }

      function loadChatHistory(id) {
        try {
          // Try to load per-material chat history first
          if (id) {
            const key = `ilmatrix_chat_${id}`;
            const saved = localStorage.getItem(key);
            if (saved) {
              const parsed = JSON.parse(saved);
              if (Array.isArray(parsed)) {
                chat = parsed;
                return true;
              }
            }
          }

          // Fallback: try to load global chat history
          const globalSaved = localStorage.getItem("ilmatrix_chat_global");
          if (globalSaved) {
            const parsed = JSON.parse(globalSaved);
            if (Array.isArray(parsed)) {
              chat = parsed;
              return true;
            }
          }
        } catch (e) {
          console.warn("Failed to load chat history from localStorage:", e);
        }
        chat = []; // Reset to empty if load fails
        return false;
      }

      function clearChatHistory(id) {
        try {
          // Clear per-material chat history
          if (id) {
            const key = `ilmatrix_chat_${id}`;
            localStorage.removeItem(key);
          }
          // Also clear global chat history
          localStorage.removeItem("ilmatrix_chat_global");
          chat = [];
        } catch (e) {
          console.warn("Failed to clear chat history from localStorage:", e);
        }
      }

      // Helper function to add message to chat with auto-save
      function addChatMessage(role, content, endpoint = null) {
        chat.push({ role, content });
        
        // Save to session if we have an active sessionId
        if (sessionId) {
          saveChatMessageToSession(role, content, endpoint);
        } else {
          // Fallback to localStorage
          saveChatHistory();
        }
        
        renderChat();
      }

      // Load the most recent chat session for authenticated users
      async function loadMostRecentSession() {
        try {
          const response = await fetch('/api/dashboard/chat/sessions?limit=1', {
            credentials: 'include'
          });
          
          if (!response.ok) return false;
          
          const data = await response.json();
          if (data.sessions && data.sessions.length > 0) {
            const recentSession = data.sessions[0];
            await loadChatSession(recentSession.id);
            return true;
          }
          
          return false;
        } catch (error) {
          console.error('Failed to load most recent session:', error);
          return false;
        }
      }

      // Quiz behavior mode: "section_mobile" | "always_section" | "composer"
      // - section_mobile: quick menu opens Quiz section on mobile (default)
      // - always_section: always navigate to Quiz section on mobile from any entry
      // - composer: route Quiz via the single composer like other tools
      const QUIZ_BEHAVIOR = "composer";

      // Helpers
      const $ = (id) => document.getElementById(id);
      const escapeHtml = (s) =>
        String(s).replace(
          /[&<>]/g,
          (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c])
        );

      // Clean chat messages for API (remove extra fields that API doesn't accept)
      function cleanMessagesForAPI(messages) {
        return messages.map(msg => ({
          role: msg.role,
          content: msg.content
          // Only include role and content, remove timestamp, materialId, etc.
        }));
      }

      // Render Markdown safely using marked + DOMPurify (fallback to escaping)
      function renderMarkdown(s) {
        try {
          const src = String(s ?? "");
          const parsed = window.marked
            ? window.marked.parse(src)
            : escapeHtml(src);
          const safe = window.DOMPurify
            ? window.DOMPurify.sanitize(parsed)
            : parsed;
          return "<div class='markdown'>" + safe + "</div>";
        } catch (e) {
          return (
            "<pre class='whitespace-pre-wrap break-words text-sm sm:text-base'><code>" +
            escapeHtml(String(s ?? "")) +
            "</code></pre>"
          );
        }
      }

      // Enhance code blocks with a "Copy" button
      function addCopyButtons(root) {
        if (!root) return;
        const blocks = root.querySelectorAll("pre > code");
        blocks.forEach((code) => {
          const pre = code.parentElement;
          if (!pre || pre.dataset.hasCopy === "1") return;
          pre.dataset.hasCopy = "1";
          pre.style.position = pre.style.position || "relative";
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "code-copy-btn absolute top-1 right-1 text-xs px-2 py-1 rounded-md border border-white/40 ring-1 ring-black/5 bg-white/80 hover:bg-white/90 text-slate-900 shadow-sm transition dark:bg-slate-800/80 dark:text-slate-100";
          btn.textContent = "Copy";
          btn.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(code.textContent || "");
              const prev = btn.textContent;
              btn.textContent = "Copied";
              setTimeout(() => (btn.textContent = prev), 1200);
            } catch (err) {
              const prev = btn.textContent;
              btn.textContent = "Error";
              setTimeout(() => (btn.textContent = prev), 1200);
            }
          });
          pre.appendChild(btn);
        });
      }

      // Standardized loading and error helpers
      function setLoading(el, text) {
        if (!el) return;
        el.innerHTML =
          '<div class="skeleton p-3"><span class="sr-only">' +
          escapeHtml(text || "Loading...") +
          "</span></div>";
      }
      function renderError(el, message) {
        if (!el) return;
        el.innerHTML =
          "<pre class='whitespace-pre-wrap break-words text-sm sm:text-base text-red-700'><code>" +
          escapeHtml(message || "Unknown error") +
          "</code></pre>";
        addCopyButtons(el);
      }

      // Tabs
      const tabs = [
        "chat",
        "upload",
        "explain",
        "quiz",
        "forum",
        "exam",
        "flashcards",
        "dialogue",
      ];
      function setActive(tab) {
        const isSmall =
          window.matchMedia && window.matchMedia("(max-width: 639px)").matches;

        // Mobile: single-composer flow
        if (isSmall) {
          const composerQuiz = QUIZ_BEHAVIOR === "composer";
          const treatAsSection =
            tab === "upload" ||
            tab === "dialogue" ||
            (tab === "quiz" && !composerQuiz);
          if (tab !== "chat" && !treatAsSection) {
            // Route via composer for tools other than Upload/Dialogue/Quiz (unless composer mode)
            if (typeof setActiveTool === "function") setActiveTool(tab);
            $("chatInput")?.focus();
            return;
          }
          if (treatAsSection) {
            // Show full section for Upload/Dialogue/Quiz on mobile; clear routing
            if (typeof setActiveTool === "function") setActiveTool("chat");
          }
        } else {
          // Desktop: open rich tools panel for non-chat tabs
          if (tab !== "chat") {
            if (typeof openTools === "function") openTools(tab);
            return;
          }
        }

        // Show/hide top-level sections
        tabs.forEach((t) => {
          const sec = $("sec-" + t);
          const btns = document.querySelectorAll(
            '.tab-btn[data-tab="' + t + '"]'
          );
          if (sec) sec.classList.toggle("hidden", t !== tab);
          // active decoration (no color override)
          btns.forEach((b) => b.classList.toggle("ring-2", t === tab));
          btns.forEach((b) => b.classList.toggle("ring-offset-2", t === tab));
          btns.forEach((b) => b.classList.toggle("ring-gray-300", t === tab));
          btns.forEach((b) => b.classList.toggle("font-semibold", t === tab));
        });

        // Focus on first focusable inside section
        const firstFocus = document.querySelector(
          "#sec-" +
            tab +
            " input, #sec-" +
            tab +
            " textarea, #sec-" +
            tab +
            " select, #sec-" +
            tab +
            " button"
        );
        if (firstFocus) firstFocus.focus({ preventScroll: true });
        // Update global mobile quick + visibility after section toggle
        if (typeof updateGlobalQuickButtonVisibility === "function") {
          try {
            updateGlobalQuickButtonVisibility();
          } catch {}
        }
      }
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => setActive(btn.dataset.tab));
      });

      // Active tool mobile-first selection (ChatGPT-like flow)
      const TOOL_ROUTES = {
        explain: {
          endpoint: "/api/explain",
          makePayload: (text) => ({ materialId, prompt: text }),
        },
        forum: {
          endpoint: "/api/forum",
          makePayload: (text) => ({ materialId, prompt: text }),
        },
        exam: {
          endpoint: "/api/exam",
          makePayload: (text) => ({ materialId, prompt: text }),
        },
        // Only used when QUIZ_BEHAVIOR === "composer"
        quiz: {
          endpoint: "/api/quiz",
          makePayload: (text) => ({ materialId, prompt: text }),
        },
      };

      function updateActiveToolBadge() {
        const badge = $("activeToolBadge");
        const label = $("activeToolLabel");
        if (!badge || !label) return;
        if (!activeTool || activeTool === "chat") {
          badge.classList.add("hidden");
          return;
        }
        label.textContent =
          activeTool.charAt(0).toUpperCase() + activeTool.slice(1);
        badge.classList.remove("hidden");
      }

      function setComposerPlaceholder() {
        const input = $("chatInput");
        if (!input) return;
        const map = {
          explain: "Explain: Notes/Questions‚Ä¶",
          forum: "Forum: Topics/Arguments‚Ä¶",
          exam: "Exam: Questions/Instructions‚Ä¶",
          quiz: "Quiz: kosongkan lalu Send untuk 5 soal; atau ketik jumlah (mis. 10); atau tempel jawaban '1 a, 2 b, ...'",
        };
        input.placeholder =
          activeTool && activeTool !== "chat"
            ? map[activeTool] || "Write here..."
            : "Write here...";
      }

      function setActiveTool(tool) {
        // Small breakpoints
        const isSmallPhone =
          window.matchMedia && window.matchMedia("(max-width: 639px)").matches;
        const isSmallTablet =
          window.matchMedia && window.matchMedia("(max-width: 765px)").matches;

        // Flashcards unavailable on small screens (< 766px)
        if (isSmallTablet && tool === "flashcards") {
          alert("Fitur Cards hanya tersedia pada layar ‚â• 766px (tablet).");
          // Do NOT change activeTool; keep composer focused.
          $("chatInput")?.focus();
          return;
        }

        // Dialogue should open its full section on mobile (not composer)
        if (isSmallPhone && tool === "dialogue") {
          // Clear composer routing and navigate to Dialogue section UI
          activeTool = "chat";
          updateActiveToolBadge();
          setComposerPlaceholder();
          setActive("dialogue");
          const firstFocus = document.querySelector(
            "#sec-dialogue input, #sec-dialogue textarea, #sec-dialogue select, #sec-dialogue button"
          );
          if (firstFocus) firstFocus.focus({ preventScroll: true });
          return;
        }

        // Default behavior
        activeTool = (tabs || []).includes(tool) ? tool : "chat";
        updateActiveToolBadge();
        setComposerPlaceholder();

        // On small screens, stay in Chat composer
        if (isSmallPhone) {
          setActive("chat");
          $("chatInput")?.focus();
        }
      }

      // Clear active tool when clicking the √ó on the badge
      document.addEventListener("click", (e) => {
        const btn =
          e.target && e.target.closest
            ? e.target.closest("#activeToolClear")
            : null;
        if (!btn) return;
        setActiveTool("chat");
      });

      // 5-Theme Cycling System with localStorage persistence
      (function () {
        const root = document.documentElement;
        const themes = ['light', 'dark', 'blue', 'pink', 'green'];
        const themeEmojis = {
          'light': '‚òÄÔ∏è',
          'dark': 'üåï',
          'blue': 'üê¨',
          'pink': 'ü¶©',
          'green': 'ü¶ñ'
        };

        const getCookie = (name) => {
          const parts = document.cookie.split("; ").filter(Boolean);
          const hit = parts.find((p) => p.startsWith(name + "="));
          return hit
            ? decodeURIComponent(hit.split("=").slice(1).join("="))
            : null;
        };

        const persist = (theme) => {
          try {
            localStorage.setItem("theme", theme);
          } catch {}
          try {
            document.cookie =
              "theme=" +
              encodeURIComponent(theme) +
              "; max-age=31536000; path=/; SameSite=Lax";
          } catch {}
        };

        const getSaved = () => {
          let v = null;
          try {
            v = localStorage.getItem("theme");
          } catch {}
          if (!v) v = getCookie("theme");
          return v && themes.includes(v) ? v : null;
        };

        const applyTheme = (theme) => {
          // Remove all theme classes
          root.classList.remove('dark', 'theme-blue', 'theme-pink', 'theme-green');

          // Apply new theme
          if (theme === 'dark') {
            root.classList.add('dark');
          } else if (theme === 'blue') {
            root.classList.add('theme-blue');
          } else if (theme === 'pink') {
            root.classList.add('theme-pink');
          } else if (theme === 'green') {
            root.classList.add('theme-green');
          }
          // 'light' = no class needed
        };

        const updateButton = (theme) => {
          const iconSun = document.querySelector('.icon-sun');
          const iconMoon = document.querySelector('.icon-moon');
          const emoji = themeEmojis[theme] || '‚òÄÔ∏è';

          if (theme === 'light') {
            if (iconSun) {
              iconSun.style.display = 'inline';
              iconSun.textContent = '‚òÄÔ∏è'; // Reset to sun emoji
            }
            if (iconMoon) iconMoon.style.display = 'none';
          } else if (theme === 'dark') {
            if (iconSun) iconSun.style.display = 'none';
            if (iconMoon) iconMoon.style.display = 'inline';
          } else {
            // For blue, pink, green - show custom emoji
            if (iconSun) {
              iconSun.style.display = 'inline';
              iconSun.textContent = emoji;
            }
            if (iconMoon) iconMoon.style.display = 'none';
          }
        };

        // Initialize theme - use state variable instead of reading classList
        const saved = getSaved();
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        const initial = saved ? saved : (prefersDark ? 'dark' : 'light');

        // State variable to track current theme
        let currentTheme = initial;

        applyTheme(currentTheme);
        updateButton(currentTheme);
        if (!saved) persist(currentTheme);

        // Theme cycle button
        const btn = document.getElementById("btnTheme");
        if (btn) {
          btn.addEventListener("click", () => {
            // Cycle to next theme using state variable
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const nextTheme = themes[nextIndex];

            // Update state
            currentTheme = nextTheme;

            applyTheme(nextTheme);
            updateButton(nextTheme);
            persist(nextTheme);
          });
        }
      })();

      // Renderers
      function renderChat() {
        const parts = chat.map((m) => {
          const role =
            m.role === "assistant"
              ? "assistant"
              : m.role === "system"
              ? "system"
              : "user";
          const isUser = role === "user";
          const who =
            role === "assistant" ? "AI" : role === "system" ? "System" : "You";

          const body =
            role === "assistant"
              ? renderMarkdown(m.content)
              : "<div class='whitespace-pre-wrap break-words text-sm sm:text-base'>" +
                escapeHtml(m.content) +
                "</div>";

          const bubbleClass =
            (isUser ? "bubble-out" : "bubble-in") +
            " rounded-2xl px-3 py-2 shadow-sm max-w-[80%] sm:max-w-[70%] transition-all duration-200 ease-out";
          const rowClass = isUser ? "justify-end" : "justify-start";
          const avatar =
            '<div class="avatar shrink-0" aria-hidden="true">' +
            (isUser ? "U" : who[0]) +
            "</div>";
          const bubble = '<div class="' + bubbleClass + '">' + body + "</div>";

          return (
            '<div class="my-2 flex ' +
            rowClass +
            ' items-start gap-2">' +
            (isUser ? "" : avatar) +
            bubble +
            (isUser ? avatar : "") +
            "</div>"
          );
        });
        const html = parts.join("");
        $("chat").innerHTML =
          html ||
          "<em class='text-slate-500'>Start chat by type your questions...</em>";
        addCopyButtons($("chat"));
        $("chat").scrollTop = $("chat").scrollHeight;

        // Auto-save chat history after rendering
        saveChatHistory();
      }

      // Health
      $("btnHealth").onclick = async () => {
        try {
          const res = await fetch("/api/health");
          const data = await res.json().catch(() => ({}));
          alert("Health: " + JSON.stringify(data));
        } catch (e) {
          alert("Health request failed: " + e.message);
        }
      };

      // Upload ‚Äî ChatGPT-like drop zone (auto-upload on select/drag-drop)
      const dropZone = $("dropZone");
      const filePicker = $("filePicker");
      const uploadInfo = $("uploadInfo");
      const attachments = $("attachments");
      const currentMaterialLabel = $("currentMaterialLabel");

      function setCurrentMaterialLabel() {
        currentMaterialLabel.textContent = materialId ? materialId : "none";
      }

      // Update material UI with loaded material data
      function updateMaterialUI(materialData) {
        if (!materialData) return;

        // Update material label
        setCurrentMaterialLabel();

        // Update attachments list
        const files = Array.isArray(materialData.files) ? materialData.files : [];
        const total = Number(materialData.totalSize || 0);
        renderAttachmentsList(files, total);
        updateAttachmentsBar(files, total);
      }

      function bytesToHuman(n) {
        const units = ["B", "KB", "MB", "GB"];
        let i = 0;
        let v = Number(n || 0);
        while (v >= 1024 && i < units.length - 1) {
          v /= 1024;
          i++;
        }
        return `${v.toFixed(v < 10 && i > 0 ? 1 : 0)} ${units[i]}`;
      }

      function updateAttachmentsBar(files, totalSize) {
        const bar = $("attachmentsBar");
        const summary = document.getElementById("attachmentsSummary");
        if (!bar || !summary) return;

        const hasFiles = Array.isArray(files) && files.length > 0;
        if (!materialId || !hasFiles) {
          bar.classList.add("hidden");
          summary.textContent = "";
          return;
        }
        const size =
          typeof totalSize === "number"
            ? totalSize
            : files.reduce((acc, f) => acc + Number(f.size || 0), 0);
        summary.textContent = files.length + " file(s) ‚Ä¢ " + bytesToHuman(size);
        bar.classList.remove("hidden");
      }

      function renderAttachmentsList(files, totalSize) {
        if (!files || !files.length) {
          attachments.innerHTML =
            "<em class='text-gray-500'>No files yet. Drop or click to upload.</em>";
        } else {
          const html = files
            .map((f) => {
              const name = String(f.name || "");
              const size = bytesToHuman(f.size || 0);
              const occ = Number(f.occurrences || 0);
              const occText = occ > 1 ? ` √ó${occ}` : "";
              return `
                <div class="flex items-center justify-between rounded-md border border-gray-200 dark:border-white/10 bg-white dark:bg-neutral-900 px-3 py-2">
                  <div class="truncate">
                    <span class="font-medium">${escapeHtml(name)}</span>
                    <span class="ml-2 text-xs text-gray-500">${size}${occText}</span>
                  </div>
                  <button
                    class="btnRemove text-xs px-2 py-1 rounded-md border border-gray-300 dark:border-white/20 hover:bg-gray-50 dark:hover:bg-white/10 dark:text-slate-100"
                    data-name="${encodeURIComponent(name)}"
                    title="Remove this file from material (destructive)"
                  >
                    Remove
                  </button>
                </div>
              `;
            })
            .join("");
          attachments.innerHTML = html;
        }
        if (typeof totalSize === "number") {
          uploadInfo.textContent = `Total size: ${bytesToHuman(
            totalSize
          )} (limit 10 MB)`;
        }
      }

      async function refreshMaterialList() {
        setCurrentMaterialLabel();
        if (!materialId) {
          attachments.innerHTML =
            "<em class='text-gray-500'>No files yet. Drop or click to upload.</em>";
          uploadInfo.textContent = "";
          updateAttachmentsBar([], 0);
          return;
        }
        try {
          const res = await fetch(`/api/material/${materialId}`);
          const data = await res.json();
          const files = Array.isArray(data.files) ? data.files : [];
          const total = Number(data.totalSize || 0);
          renderAttachmentsList(files, total);
          updateAttachmentsBar(files, total);
        } catch (e) {
          uploadInfo.textContent = "List failed: " + e.message;
          updateAttachmentsBar([], 0);
        }
      }

      async function autoUpload(selected) {
        const files = Array.from(selected || []).filter((f) => !!f);
        if (!files.length) return;
        const fd = new FormData();
        for (const f of files) fd.append("file", f);

        const doAppend = !!materialId;
        if (doAppend) {
          fd.append("append", "true");
          fd.append("mergeTo", materialId);
        }

        uploadInfo.textContent = `Uploading ${files.length} file(s)...`;
        try {
          const res = await fetch("/api/upload", { method: "POST", body: fd });
          const data = await res.json();
          if (data.materialId) {
            saveMaterialId(data.materialId);
            setCurrentMaterialLabel();
            uploadInfo.textContent = `Uploaded ${data.files} file(s). size=${
              data.size
            } ${data.sizeAdded ? "(+" + data.sizeAdded + ")" : ""} limit=${
              data.limit
            }`;
            await refreshMaterialList();
          } else {
            uploadInfo.textContent = "Upload error: " + JSON.stringify(data);
          }
        } catch (e) {
          uploadInfo.textContent = "Upload failed: " + e.message;
        }
      }

      // Click on drop zone opens file picker
      if (dropZone) {
        dropZone.addEventListener(
          "click",
          () => filePicker && filePicker.click()
        );
        dropZone.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            filePicker && filePicker.click();
          }
        });
        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("ring-2", "ring-gray-300");
        });
        dropZone.addEventListener("dragleave", () => {
          dropZone.classList.remove("ring-2", "ring-gray-300");
        });
        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          dropZone.classList.remove("ring-2", "ring-gray-300");
          const dt = e.dataTransfer;
          const files = dt && dt.files ? Array.from(dt.files) : [];
          if (files.length) autoUpload(files);
        });
      }

      // File picker change -> auto upload
      if (filePicker) {
        filePicker.addEventListener("change", () => {
          const files = Array.from(filePicker.files || []);
          // reset value so same file can be selected again later
          filePicker.value = "";
          if (files.length) autoUpload(files);
        });
      }

      // Remove attachment (delegated)
      if (attachments) {
        attachments.addEventListener("click", async (e) => {
          const btn =
            e.target && e.target.closest
              ? e.target.closest(".btnRemove")
              : null;
          if (!btn) return;
          if (!materialId) return;
          const name = decodeURIComponent(btn.getAttribute("data-name") || "");
          if (!name) return;
          uploadInfo.textContent = `Removing ${name}...`;
          try {
            const res = await fetch(`/api/material/${materialId}/remove`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name }),
            });
            const data = await res.json();
            if (data && data.materialId) {
              uploadInfo.textContent = `Removed "${name}". Total size: ${bytesToHuman(
                data.totalSize || 0
              )}`;
              await refreshMaterialList();
            } else {
              uploadInfo.textContent = "Remove error: " + JSON.stringify(data);
            }
          } catch (err) {
            uploadInfo.textContent = "Remove failed: " + err.message;
          }
        });
      }

      // Remove ALL attachments (toolbar button)
      async function clearAllAttachments() {
        if (!materialId) {
          alert("No material to clear");
          return;
        }
        try {
          // Get current files for this material
          const res = await fetch(`/api/material/${materialId}`);
          const data = await res.json();
          const files = Array.isArray(data.files) ? data.files : [];
          if (!files.length) {
            updateAttachmentsBar([], 0);
            attachments.innerHTML =
              "<em class='text-gray-500'>No files yet. Drop or click to upload.</em>";
            uploadInfo.textContent = "";
            return;
          }
          uploadInfo.textContent = `Removing ${files.length} file(s)...`;
          for (const f of files) {
            const name = String(f?.name || "");
            if (!name) continue;
            try {
              await fetch(`/api/material/${materialId}/remove`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name }),
              });
            } catch {}
          }
          await refreshMaterialList();
        } catch (e) {
          uploadInfo.textContent = "Clear all failed: " + e.message;
        }
      }

      // Start new material (client-side reset; does not delete existing server files)
      $("btnNewMaterial").onclick = () => {
        saveMaterialId(null);
        setCurrentMaterialLabel();
        attachments.innerHTML =
          "<em class='text-gray-500'>New material. Drop or click to upload.</em>";
        uploadInfo.textContent = "";
      };

      // Initialize from URL parameters and localStorage
      async function initializeApp() {
        // Check URL parameters first
        const urlParams = new URLSearchParams(window.location.search);
        const urlSessionId = urlParams.get('sessionId');
        const urlMaterialId = urlParams.get('materialId');
        
        if (urlSessionId) {
          // Load specific chat session
          await loadChatSession(urlSessionId);
          return; // Exit early, don't load from localStorage
        } else if (urlMaterialId) {
          // Load specific material
          const exists = await verifyMaterialExists(urlMaterialId);
          if (exists) {
            saveMaterialId(urlMaterialId);
            loadChatHistory(urlMaterialId);
            setCurrentMaterialLabel();
            await refreshMaterialList();
            renderChat();
          }
        } else {
          // For authenticated users, try to load their most recent session
          const authStatus = await checkAuthStatus();
          if (authStatus && authStatus.isAuthenticated) {
            const sessionLoaded = await loadMostRecentSession();
            if (sessionLoaded) return; // Exit early if session was loaded
          } else {
            // Initialize from localStorage for guests
            const saved = loadMaterialId();
            if (saved) {
              const exists = await verifyMaterialExists(saved);
              if (exists) {
                loadChatHistory(saved);
                setCurrentMaterialLabel();
                await refreshMaterialList();
                renderChat();
              } else {
                // Material expired or doesn't exist, clear it
                clearChatHistory(saved);
                saveMaterialId(null);
                setCurrentMaterialLabel();
              }
            } else {
              // No saved materialId, try to load global chat history
              loadChatHistory(null);
              setCurrentMaterialLabel();
              renderChat();
            }
          }
        }
      }

      // Initial render
      initializeApp();
      // No material at first; keep empty list text

      // Shared runner to show JSON or answer into a target element
      async function runAndShow(endpoint, payload, targetId) {
        const el = $(targetId);
        if (!el) return;
        setLoading(el, "Processing...");
        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          
          // Handle guest usage limits
          if (res.status === 401) {
            const errorData = await res.json();
            if (errorData.requiresAuth) {
              handleGuestLimitReached(errorData, el);
              return;
            }
          }
          
          // Update guest usage counter from headers
          updateGuestUsageDisplay(res.headers);
          
          const data = await res.json();
          if (data && typeof data.answer === "string" && data.answer.trim()) {
            el.innerHTML = renderMarkdown(data.answer);
          } else {
            el.innerHTML =
              "<pre class='whitespace-pre-wrap break-words text-sm sm:text-base'><code>" +
              escapeHtml(JSON.stringify(data, null, 2)) +
              "</code></pre>";
          }
          addCopyButtons(el);
        } catch (e) {
          renderError(el, e.message);
        }
      }

      // Render MCQ UI into a given container
      function renderMCQ(questions, containerId) {
        const container = $(containerId);
        if (!container) return;
        if (!questions || !questions.length) {
          container.innerHTML =
            "<em class='text-gray-500'>No questions yet.</em>";
          return;
        }
        const letters = ["A", "B", "C", "D", "E"];
        const html = questions
          .map((q, qi) => {
            const opts = (q.options || [])
              .slice(0, 5)
              .map((opt, oi) => {
                const letter = letters[oi];
                return (
                  '<div class="pl-1 text-sm"><strong>' +
                  letter +
                  ".</strong> " +
                  escapeHtml(opt) +
                  "</div>"
                );
              })
              .join("");
            return (
              '<div class="rounded-md border border-gray-200 dark:border-white/10 bg-white dark:bg-neutral-900 p-3">' +
              '<div class="font-medium">' +
              (qi + 1) +
              ") " +
              escapeHtml(q.question) +
              "</div>" +
              '<div class="mt-1 grid gap-1">' +
              opts +
              "</div></div>"
            );
          })
          .join("");
        container.innerHTML = html;
      }

      // Helpers for Quiz (composer mode)
      function mcqToMarkdown(questions) {
        const letters = ["A", "B", "C", "D", "E"];
        if (!Array.isArray(questions) || !questions.length)
          return "Tidak ada soal.";
        let out = "";
        questions.forEach((q, i) => {
          const qText = escapeHtml(q?.question || "");
          out += `${i + 1}) ${qText}\n`;
          const opts = Array.isArray(q?.options) ? q.options.slice(0, 5) : [];
          opts.forEach((opt, oi) => {
            const letter = letters[oi] || String.fromCharCode(65 + oi);
            out += ` - ${letter}. ${escapeHtml(opt || "")}\n`;
          });
          out += "\n";
        });
        return out.trim();
      }

      function parseAnswersForQuestions(text, questions) {
        // Accept both newline-separated and comma-separated tokens.
        // Pattern per token: /^\s*(\d+)\s*([a-eA-E])\s*$/
        const tokens = String(text || "")
          .split(/[,\n]/)
          .map((t) => t.trim())
          .filter(Boolean);

        const userAnswers = {};
        const missing = [];
        const byIndex = new Map();

        for (const tk of tokens) {
          const m = tk.match(/^\s*(\d+)\s*([a-eA-E])\s*$/);
          if (m) {
            const idx = Number(m[1]);
            const letter = m[2].toUpperCase();
            if (!byIndex.has(idx)) byIndex.set(idx, letter);
          }
        }
        (questions || []).forEach((q, i) => {
          const idx = i + 1;
          const letter = byIndex.get(idx);
          if (!letter) missing.push(idx);
          else userAnswers[q.id] = letter;
        });
        return { userAnswers, missing };
      }

      async function handleQuizComposer(text) {
        if (!materialId) {
          alert("Upload material first");
          return;
        }
        const trimmed = (text || "").trim();

        // When empty: default generate 5 MCQs
        if (!trimmed) {
          try {
            const res = await fetch("/api/quiz/trainer/mcq/start", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ materialId, numQuestions: 5 }),
            });
            const data = await res.json();
            mcqQuestions = Array.isArray(data.questions) ? data.questions : [];
            const md = "Berikut MCQ:\n\n" + mcqToMarkdown(mcqQuestions);
            addChatMessage("assistant", md, "quiz");
          } catch (e) {
            addChatMessage("system", "Quiz error: " + e.message);
          }
          return;
        }

        // Answers format: accept per-line or comma-separated tokens like "1 a, 2 b, ..."
        const tokens = trimmed
          .split(/[,\n]/)
          .map((t) => t.trim())
          .filter(Boolean);
        const looksLikeAnswers =
          tokens.length > 0 &&
          tokens.every((tk) => /^\s*\d+\s*([a-eA-E])\s*$/.test(tk));

        if (
          looksLikeAnswers &&
          Array.isArray(mcqQuestions) &&
          mcqQuestions.length
        ) {
          try {
            const { userAnswers, missing } = parseAnswersForQuestions(
              trimmed,
              mcqQuestions
            );
            if (missing.length) {
              chat.push({
                role: "system",
                content: "Jawab semua nomor: " + missing.join(", "),
              });
              renderChat();
              return;
            }
            const res = await fetch("/api/quiz/trainer/mcq/score", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                materialId,
                questions: mcqQuestions,
                userAnswers,
              }),
            });
            const data = await res.json();
            const analysis = data.analysis || JSON.stringify(data);
            chat.push({ role: "assistant", content: analysis });
            renderChat();
          } catch (e) {
            chat.push({
              role: "system",
              content: "Scoring error: " + e.message,
            });
            renderChat();
          }
          return;
        }

        // Generate N if user typed only a number 1..20, or number + clear generation intent
        const pureNum = trimmed.match(/^\s*(\d{1,2})\s*$/);
        if (pureNum) {
          try {
            const n = Math.max(1, Math.min(20, Number(pureNum[1])));
            const res = await fetch("/api/quiz/trainer/mcq/start", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ materialId, numQuestions: n }),
            });
            const data = await res.json();
            mcqQuestions = Array.isArray(data.questions) ? data.questions : [];
            const md = `Berikut ${n} MCQ:\n\n` + mcqToMarkdown(mcqQuestions);
            chat.push({ role: "assistant", content: md });
            renderChat();
          } catch (e) {
            chat.push({ role: "system", content: "Quiz error: " + e.message });
            renderChat();
          }
          return;
        }
        const numMatch = trimmed.match(/\b(\d{1,2})\b/);
        const hasCountIntent =
          /\b(soal|soalan|pertanyaan|question|questions|mcq|quiz|buat|generate|buatkan|buatlah)\b/i.test(
            trimmed
          );
        if (numMatch && hasCountIntent) {
          try {
            const n = Math.max(1, Math.min(20, Number(numMatch[1])));
            const res = await fetch("/api/quiz/trainer/mcq/start", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ materialId, numQuestions: n }),
            });
            const data = await res.json();
            mcqQuestions = Array.isArray(data.questions) ? data.questions : [];
            const md = `Berikut ${n} MCQ:\n\n` + mcqToMarkdown(mcqQuestions);
            chat.push({ role: "assistant", content: md });
            renderChat();
          } catch (e) {
            chat.push({ role: "system", content: "Quiz error: " + e.message });
            renderChat();
          }
          return;
        }

        // Fallback to freeform /api/quiz
        try {
          const res = await fetch("/api/quiz", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ materialId, prompt: trimmed }),
          });
          const data = await res.json();
          const answer = data.answer || JSON.stringify(data);
          chat.push({ role: "assistant", content: answer });
          renderChat();
        } catch (e) {
          chat.push({ role: "system", content: "Quiz error: " + e.message });
          renderChat();
        }
      }

      // Explain
      $("btnExplain").onclick = async () => {
        if (!materialId) {
          alert("Upload material first");
          return;
        }
        const prompt = $("promptExplain").value || "";
        await runAndShow(
          "/api/explain",
          { materialId, prompt },
          "explainResult"
        );
      };

      // QUIZ ‚Äî Generate MCQ
      $("btnGenerateQuizMCQ").onclick = async () => {
        if (!materialId) {
          alert("Upload material first");
          return;
        }
        const n = Number($("numQuestions").value || 5);
        const containerId = "quizMCQ";
        setLoading($(containerId), "Generating...");
        $("quizResult").textContent = "";
        $("quizAnswers").value = "";
        mcqQuestions = [];
        try {
          const res = await fetch("/api/quiz/trainer/mcq/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ materialId, numQuestions: n }),
          });
          const data = await res.json();
          mcqQuestions = Array.isArray(data.questions) ? data.questions : [];
          renderMCQ(mcqQuestions, containerId);
        } catch (e) {
          renderError($(containerId), e.message);
        }
      };

      // QUIZ ‚Äî Submit simple text answers: "1 a", "2 b", ...
      $("btnSubmitQuizMCQ").onclick = async () => {
        if (!materialId) {
          alert("Upload material first");
          return;
        }
        if (!mcqQuestions || mcqQuestions.length === 0) {
          alert("Generate quiz first");
          return;
        }
        const raw = ($("quizAnswers").value || "").trim();
        if (!raw) {
          alert("Isi jawaban dulu, contoh:\n1 a\n2 b\n3 c");
          return;
        }
        // Parse lines: "<index> <letter>"
        const lines = raw.split(/\r?\n/);
        const userAnswers = {};
        const missing = [];
        for (let i = 0; i < mcqQuestions.length; i++) {
          const idx = i + 1; // displayed number
          const q = mcqQuestions[i];
          const line = lines.find((ln) =>
            new RegExp("^\\s*" + idx + "\\s+([a-eA-E])\\s*$").test(ln)
          );
          if (!line) {
            missing.push(idx);
            continue;
          }
          const m = line.match(/([a-eA-E])/);
          if (m) userAnswers[q.id] = m[1].toUpperCase();
        }
        if (missing.length) {
          alert("Jawab semua nomor: " + missing.join(", "));
          return;
        }
        setLoading($("quizResult"), "Scoring...");
        try {
          const res = await fetch("/api/quiz/trainer/mcq/score", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              materialId,
              questions: mcqQuestions,
              userAnswers,
            }),
          });
          const data = await res.json();
          $("quizResult").textContent = data.analysis || JSON.stringify(data);
        } catch (e) {
          renderError($("quizResult"), e.message);
        }
      };

      // Forum
      $("btnForum").onclick = async () => {
        if (!materialId) {
          alert("Upload material first");
          return;
        }
        const prompt = $("promptForum").value || "";
        await runAndShow("/api/forum", { materialId, prompt }, "forumResult");
      };

      // Exam
      $("btnExam").onclick = async () => {
        if (!materialId) {
          alert("Upload material first");
          return;
        }
        const prompt = $("promptExam").value || "";
        await runAndShow("/api/exam", { materialId, prompt }, "examResult");
      };

      // Flashcards
      $("btnGenerateCards").onclick = async () => {
        if (!materialId) {
          alert("Upload material first");
          return;
        }
        const n = Number($("numCards").value || 5);
        const list = $("flashcardsList");
        setLoading(list, "Generating...");
        try {
          const res = await fetch("/api/flashcards", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ materialId, numCards: n }),
          });
          const data = await res.json();
          const cards = Array.isArray(data.cards) ? data.cards : [];
          renderFlashcards(cards);
        } catch (e) {
          renderError(list, e.message);
        }
      };

      function renderFlashcards(cards) {
        const list = $("flashcardsList");
        if (!cards || !cards.length) {
          list.innerHTML = "<em class='text-gray-500'>No flashcards.</em>";
          return;
        }
        const html = cards
          .map((c, i) => {
            const idx = i + 1;
            const q = (c.front || c.q || "").toString();
            const a = (c.back || c.a || "").toString();
            const id = "fc-" + (c.id || idx);
            return (
              '<div class="fc-scene">' +
              '<div class="fc-card" id="' +
              id +
              '" role="button" aria-label="Flip flashcard ' +
              idx +
              '" tabindex="0" ' +
              "onclick=\"flipCard('" +
              id +
              "')\" " +
              "onkeypress=\"if(event.key==='Enter'||event.key===' ') flipCard('" +
              id +
              "')\" >" +
              '<div class="fc-face fc-front">' +
              '<div class="text-sm sm:text-base"><span class="font-semibold text-primary">' +
              idx +
              ")</span> " +
              renderMarkdown(q) +
              "</div>" +
              '<div class="fc-hint">Click / Press Enter to flip</div>' +
              "</div>" +
              '<div class="fc-face fc-back">' +
              '<div class="text-sm sm:text-base">' +
              renderMarkdown(a) +
              "</div>" +
              '<div class="fc-hint">Click again to flip back</div>' +
              "</div>" +
              "</div>" +
              "</div>"
            );
          })
          .join("");
        list.innerHTML = html;
        addCopyButtons(list);
      }
      function flipCard(id) {
        const el = document.getElementById(id);
        if (el) el.classList.toggle("is-flipped");
      }

      // Chat (General)
      $("btnSend").onclick = sendChat;
      // Auto-expand textarea as user types
      const chatInput = $("chatInput");
      function autoExpandTextarea(textarea) {
        // Reset height to auto to get the correct scrollHeight
        textarea.style.height = 'auto';
        // Set height to scrollHeight (content height)
        const newHeight = Math.min(textarea.scrollHeight, 200); // Max 200px
        textarea.style.height = newHeight + 'px';
      }

      chatInput.addEventListener("input", () => {
        autoExpandTextarea(chatInput);
      });

      chatInput.addEventListener("keydown", (e) => {
        // Enter sends; Shift+Enter inserts newline
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendChat();
        }
      });
      async function sendChat() {
        const input = $("chatInput");
        const original = input.value || "";
        const trimmed = original.trim();

        // Intercept Quiz when routed via composer (supports empty input)
        if (activeTool === "quiz") {
          if (!materialId) {
            alert("Upload material first");
            return;
          }
          if (trimmed.length > 0) {
            addChatMessage("user", original);
          }
          input.value = "";
          try {
            await handleQuizComposer(trimmed);
          } catch (e) {
            addChatMessage("system", "Quiz error: " + e.message);
          }
          return;
        }

        // Explain and Exam optional behavior (empty input uses defaults)
        if (
          (activeTool === "explain" || activeTool === "exam") &&
          trimmed.length === 0
        ) {
          if (!materialId) {
            alert("Upload material first");
            return;
          }
          const defaultPrompt =
            activeTool === "explain"
              ? "Jelaskan materi ini secara ringkas dan jelas (bahasa Indonesia)."
              : "Buat kisi-kisi ujian ringkas dan contoh soal berdasarkan materi ini (bahasa Indonesia).";
          // Minimal user marker
          chat.push({
            role: "user",
            content: activeTool === "explain" ? "[Explain]" : "[Exam]",
          });
          input.value = "";
          renderChat();
          try {
            const route = TOOL_ROUTES[activeTool];
            const res = await fetch(route.endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(route.makePayload(defaultPrompt)),
            });
            
            // Handle guest usage limits
            if (res.status === 401) {
              const errorData = await res.json();
              if (errorData.requiresAuth) {
                handleGuestLimitReached(errorData);
                return;
              }
            }
            
            // Update guest usage counter from headers
            updateGuestUsageDisplay(res.headers);
            
            const data = await res.json();
            const answer = data.answer || JSON.stringify(data);
            chat.push({ role: "assistant", content: answer });
            renderChat();
          } catch (e) {
            chat.push({
              role: "system",
              content:
                (activeTool === "explain" ? "Explain" : "Exam") +
                " error: " +
                e.message,
            });
            renderChat();
          }
          return;
        }

        // Forum remains required: block empty sends
        if (activeTool === "forum" && trimmed.length === 0) {
          alert("Masukkan Questions/Forum topics");
          return;
        }

        // For other tools and general chat, keep behavior:
        if (!trimmed) return;

        addChatMessage("user", original);
        input.value = "";
        input.style.height = 'auto'; // Reset textarea height after send
        try {
          // Route to selected tool endpoints if any (Explain/Forum/Exam with text)
          if (activeTool && activeTool !== "chat" && TOOL_ROUTES[activeTool]) {
            if (!materialId) {
              alert("Upload material first");
              return;
            }
            const route = TOOL_ROUTES[activeTool];
            const body = route.makePayload(trimmed);
            const res = await fetch(route.endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            });
            
            // Handle guest usage limits
            if (res.status === 401) {
              const errorData = await res.json();
              if (errorData.requiresAuth) {
                handleGuestLimitReached(errorData);
                return;
              }
            }
            
            // Update guest usage counter from headers
            updateGuestUsageDisplay(res.headers);
            
            const data = await res.json();
            const answer = data.answer || JSON.stringify(data);
            addChatMessage("assistant", answer, activeTool);
            return;
          }

          // Default general chat
          const payload = {
            materialId: materialId || undefined,
            messages: cleanMessagesForAPI(chat),  // CRITICAL FIX: Clean messages before sending
          };
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          
          // Handle guest usage limits
          if (res.status === 401) {
            const errorData = await res.json();
            if (errorData.requiresAuth) {
              handleGuestLimitReached(errorData);
              return;
            }
          }
          
          // Update guest usage counter from headers
          updateGuestUsageDisplay(res.headers);
          
          const data = await res.json();
          const answer = data.answer || JSON.stringify(data);
          addChatMessage("assistant", answer, "chat");
        } catch (e) {
          addChatMessage("system", "Chat error: " + e.message);
        }
      }

      // Tools panel (in-place all features, no navigation)
      const btnActionMenu = $("btnActionMenu");
      const toolsPanel = $("toolsPanel");
      const toolsList = $("toolsList");
      const toolsContent = $("toolsContent");
      let toolsDockInit = false;
      const toolsBackdrop = $("toolsBackdrop");
      let toolsKeydownTrap = null;
      let lastFocusEl = null;

      // Quick menu (mobile)
      const quickMenu = $("quickMenu");
      let quickMenuOpen = false;
      const isSmallScreen = () =>
        window.matchMedia && window.matchMedia("(max-width: 639px)").matches;

      function ensureToolsDock() {
        if (toolsDockInit) return;
        // Move feature sections into the tools content host
        const list = (tabs || []).filter((t) => t !== "chat");
        list.forEach((t) => {
          const sec = $("sec-" + t);
          if (!sec) return;
          // Ensure visible internally; wrapper controls visibility
          sec.classList.remove("hidden");
          const wrap = document.createElement("div");
          wrap.className = "toolDockSection";
          wrap.setAttribute("data-tool", t);
          wrap.id = "panel-" + t;
          wrap.setAttribute("role", "tabpanel");
          wrap.setAttribute("aria-labelledby", "tab-" + t);
          wrap.setAttribute("aria-hidden", "true");
          wrap.appendChild(sec);
          toolsContent.appendChild(wrap);
        });
        // Hide all by default; selection will show one
        toolsContent.querySelectorAll(".toolDockSection").forEach((el) => {
          el.classList.add("hidden");
          el.setAttribute("aria-hidden", "true");
        });
        toolsDockInit = true;
      }

      function selectTool(tool) {
        ensureToolsDock();
        const wanted = tabs.includes(tool) ? tool : "upload";

        // Toggle panels visibility + aria-hidden
        toolsContent.querySelectorAll(".toolDockSection").forEach((el) => {
          const isActive = el.getAttribute("data-tool") === wanted;
          el.classList.toggle("hidden", !isActive);
          el.setAttribute("aria-hidden", isActive ? "false" : "true");
        });

        // Update tabs state: classes + aria-selected + roving tabindex
        if (toolsList) {
          toolsList.querySelectorAll("[data-tool]").forEach((btn) => {
            const active = btn.getAttribute("data-tool") === wanted;

            // Active state: solid dark chip with white text, no hover lightening
            btn.classList.toggle("bg-gray-900", active);
            btn.classList.toggle("text-white", active);
            btn.classList.toggle("cursor-default", active);

            // For non-active, ensure hover background/text are enabled
            if (active) {
              btn.classList.remove("hover:bg-gray-100");
              btn.classList.remove("dark:hover:bg-white/10");
            } else {
              if (!btn.classList.contains("hover:bg-gray-100"))
                btn.classList.add("hover:bg-gray-100");
              if (!btn.classList.contains("dark:hover:bg-white/10"))
                btn.classList.add("dark:hover:bg-white/10");
              btn.classList.remove("cursor-default");
              btn.classList.remove("bg-gray-900", "text-white");
            }

            // Accessibility attributes
            btn.setAttribute("aria-selected", active ? "true" : "false");
            btn.setAttribute("tabindex", active ? "0" : "-1");
          });
        }

        // Focus first focusable inside active tool
        const firstFocus = toolsContent.querySelector(
          '[data-tool="' +
            wanted +
            '"] input, [data-tool="' +
            wanted +
            '"] textarea, [data-tool="' +
            wanted +
            '"] select, [data-tool="' +
            wanted +
            '"] button'
        );
        if (firstFocus) firstFocus.focus({ preventScroll: true });
      }

      function openTools(initialTool) {
        ensureToolsDock();
        if (toolsPanel) {
          toolsPanel.classList.remove("hidden");
          btnActionMenu?.setAttribute("aria-expanded", "true");
        }
        if (toolsBackdrop) toolsBackdrop.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
        lastFocusEl = document.activeElement;

        // Focus trap within toolsPanel
        toolsKeydownTrap = function (e) {
          if (e.key !== "Tab") return;
          const selectors =
            'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
          const els = Array.from(toolsPanel.querySelectorAll(selectors)).filter(
            (el) => !!(el.offsetParent || el.getClientRects().length)
          );
          if (!els.length) return;
          const first = els[0];
          const last = els[els.length - 1];
          if (e.shiftKey) {
            if (document.activeElement === first) {
              e.preventDefault();
              last.focus({ preventScroll: true });
            }
          } else {
            if (document.activeElement === last) {
              e.preventDefault();
              first.focus({ preventScroll: true });
            }
          }
        };
        toolsPanel?.addEventListener("keydown", toolsKeydownTrap);

        selectTool(initialTool || "upload");
      }

      function closeTools() {
        if (toolsPanel) {
          toolsPanel.classList.add("hidden");
          btnActionMenu?.setAttribute("aria-expanded", "false");
        }
        if (toolsBackdrop) toolsBackdrop.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
        if (toolsKeydownTrap) {
          toolsPanel?.removeEventListener("keydown", toolsKeydownTrap);
          toolsKeydownTrap = null;
        }
        if (lastFocusEl && typeof lastFocusEl.focus === "function") {
          lastFocusEl.focus({ preventScroll: true });
        } else {
          btnActionMenu?.focus({ preventScroll: true });
        }
      }

      function openQuickMenu() {
        if (!quickMenu) return;
        quickMenu.classList.remove("hidden");
        quickMenuOpen = true;
        btnActionMenu?.setAttribute("aria-expanded", "true");
        // Initialize roving tabindex and focus first item
        const items = Array.from(
          quickMenu.querySelectorAll('.quick-item[role="menuitem"]')
        );
        items.forEach((el, i) =>
          el.setAttribute("tabindex", i === 0 ? "0" : "-1")
        );
        if (items[0]) items[0].focus({ preventScroll: true });
      }
      function closeQuickMenu() {
        if (!quickMenu) return;
        quickMenu.classList.add("hidden");
        quickMenuOpen = false;
        btnActionMenu?.setAttribute("aria-expanded", "false");
        // Restore focus to opener for accessibility
        btnActionMenu?.focus({ preventScroll: true });
      }

      if (quickMenu) {
        // Keyboard navigation (roving tabindex) for quick menu
        const getItems = () =>
          Array.from(
            quickMenu.querySelectorAll('.quick-item[role="menuitem"]')
          );

        const moveFocus = (nextIdx) => {
          const items = getItems();
          if (!items.length) return;
          const current = document.activeElement;
          let idx = Math.max(
            0,
            items.findIndex((el) => el === current)
          );
          if (Number.isFinite(nextIdx)) {
            idx = ((nextIdx % items.length) + items.length) % items.length;
          }
          items.forEach((el, i) =>
            el.setAttribute("tabindex", i === idx ? "0" : "-1")
          );
          items[idx].focus({ preventScroll: true });
        };

        quickMenu.addEventListener("keydown", (e) => {
          if (!quickMenuOpen) return;
          const items = getItems();
          if (!items.length) return;

          const idx = items.findIndex((el) => el === document.activeElement);

          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              moveFocus(idx + 1);
              break;
            case "ArrowUp":
              e.preventDefault();
              moveFocus(idx - 1);
              break;
            case "Home":
              e.preventDefault();
              moveFocus(0);
              break;
            case "End":
              e.preventDefault();
              moveFocus(items.length - 1);
              break;
            case "Enter":
            case " ":
              e.preventDefault();
              if (idx >= 0) items[idx].click();
              break;
            case "Escape":
              e.preventDefault();
              closeQuickMenu();
              break;
            case "Tab":
              // Close menu and allow natural tab order to continue
              closeQuickMenu();
              break;
          }
        });

        quickMenu.addEventListener("click", (e) => {
          const item =
            e.target && e.target.closest
              ? e.target.closest(".quick-item")
              : null;
          if (!item) return;
          const action = item.getAttribute("data-menu");
          if (action === "upload") {
            if (filePicker && typeof filePicker.click === "function")
              filePicker.click();
            closeQuickMenu();
            setActiveTool("chat");
            $("chatInput")?.focus();
            return;
          }
          // Mobile special-case: Dialogue opens as full section, not via composer
          if (action === "dialogue" && isSmallScreen()) {
            closeQuickMenu();
            setActiveTool("chat"); // clear composer routing
            setActive("dialogue");
            return;
          }
          setActiveTool(action);
          closeQuickMenu();
          $("chatInput")?.focus();
        });
      }
      if (btnActionMenu) {
        btnActionMenu.addEventListener("click", (e) => {
          e.stopPropagation();
          if (isSmallScreen()) {
            // Mobile: toggle quick menu
            if (quickMenuOpen) closeQuickMenu();
            else openQuickMenu();
          } else {
            // Desktop: toggle desktop tools panel
            if (toolsPanel?.classList.contains("hidden")) openTools("upload");
            else closeTools();
          }
        });
      }

      // Global mobile floating quick action (+)
      const btnActionMenuGlobal = $("btnActionMenuGlobal");
      const quickMenuGlobal = $("quickMenuGlobal");
      const globalQuickMenuWrap = document.getElementById(
        "globalQuickMenuWrap"
      );
      let quickMenuGlobalOpen = false;

      function updateGlobalQuickButtonVisibility() {
        const small =
          (typeof isSmallScreen === "function" && isSmallScreen()) ||
          (window.matchMedia &&
            window.matchMedia("(max-width: 639px)").matches);
        const chatSec = $("sec-chat");
        const chatHidden = chatSec
          ? chatSec.classList.contains("hidden")
          : false;

        // Detect Dialogue visibility
        const dialogueSec = $("sec-dialogue");
        const dialogueVisible =
          dialogueSec && !dialogueSec.classList.contains("hidden");

        if (!globalQuickMenuWrap) return;

        // Wrapper visibility: keep wrapper on small screens when Chat is hidden
        // so the menu can still open (e.g., from Dialogue inline +).
        if (small && chatHidden) {
          globalQuickMenuWrap.classList.remove("hidden");
        } else {
          globalQuickMenuWrap.classList.add("hidden");
          closeQuickMenuGlobal();
        }

        // Hide only the floating button during Dialogue to avoid duplicate "+".
        // Keep wrapper visible to host the menu opened by the inline "+".
        const btnGlobal = $("btnActionMenuGlobal");
        if (btnGlobal) {
          if (dialogueVisible) {
            btnGlobal.classList.add("opacity-0", "pointer-events-none");
          } else {
            btnGlobal.classList.remove("opacity-0", "pointer-events-none");
          }
        }
      }

      function openQuickMenuGlobal() {
        if (!quickMenuGlobal) return;
        quickMenuGlobal.classList.remove("hidden");
        quickMenuGlobalOpen = true;
        btnActionMenuGlobal?.setAttribute("aria-expanded", "true");
        const items = Array.from(
          quickMenuGlobal.querySelectorAll('.quick-item[role="menuitem"]')
        );
        items.forEach((el, i) =>
          el.setAttribute("tabindex", i === 0 ? "0" : "-1")
        );
        if (items[0]) items[0].focus({ preventScroll: true });
      }
      function closeQuickMenuGlobal() {
        if (!quickMenuGlobal) return;
        quickMenuGlobal.classList.add("hidden");
        if (quickMenuGlobalOpen) {
          quickMenuGlobalOpen = false;
          btnActionMenuGlobal?.setAttribute("aria-expanded", "false");
          btnActionMenuGlobal?.focus({ preventScroll: true });
        }
      }

      if (quickMenuGlobal) {
        const getGlobalItems = () =>
          Array.from(
            quickMenuGlobal.querySelectorAll('.quick-item[role="menuitem"]')
          );

        const moveGlobalFocus = (nextIdx) => {
          const items = getGlobalItems();
          if (!items.length) return;
          const current = document.activeElement;
          let idx = Math.max(
            0,
            items.findIndex((el) => el === current)
          );
          if (Number.isFinite(nextIdx)) {
            idx = ((nextIdx % items.length) + items.length) % items.length;
          }
          items.forEach((el, i) =>
            el.setAttribute("tabindex", i === idx ? "0" : "-1")
          );
          items[idx].focus({ preventScroll: true });
        };

        quickMenuGlobal.addEventListener("keydown", (e) => {
          if (!quickMenuGlobalOpen) return;
          const items = getGlobalItems();
          if (!items.length) return;

          const idx = items.findIndex((el) => el === document.activeElement);

          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              moveGlobalFocus(idx + 1);
              break;
            case "ArrowUp":
              e.preventDefault();
              moveGlobalFocus(idx - 1);
              break;
            case "Home":
              e.preventDefault();
              moveGlobalFocus(0);
              break;
            case "End":
              e.preventDefault();
              moveGlobalFocus(items.length - 1);
              break;
            case "Enter":
            case " ":
              e.preventDefault();
              if (idx >= 0) items[idx].click();
              break;
            case "Escape":
              e.preventDefault();
              closeQuickMenuGlobal();
              break;
            case "Tab":
              // Close menu and allow natural tab order to continue
              closeQuickMenuGlobal();
              break;
          }
        });

        quickMenuGlobal.addEventListener("click", (e) => {
          const item =
            e.target && e.target.closest
              ? e.target.closest(".quick-item")
              : null;
          if (!item) return;
          const action = item.getAttribute("data-menu");
          if (action === "upload") {
            if (filePicker && typeof filePicker.click === "function")
              filePicker.click();
            closeQuickMenuGlobal();
            setActiveTool("chat");
            $("chatInput")?.focus();
            return;
          }
          // Mobile special-case: Dialogue opens as full section, not via composer
          if (action === "dialogue" && isSmallScreen()) {
            closeQuickMenuGlobal();
            setActiveTool("chat"); // clear composer routing
            setActive("dialogue");
            return;
          }
          setActiveTool(action);
          closeQuickMenuGlobal();
          $("chatInput")?.focus();
        });
      }

      if (btnActionMenuGlobal) {
        btnActionMenuGlobal.addEventListener("click", (e) => {
          e.stopPropagation();
          if (isSmallScreen()) {
            if (quickMenuGlobalOpen) closeQuickMenuGlobal();
            else openQuickMenuGlobal();
          }
        });
      }

      // Mobile-only Dialogue inline (+) uses a local anchored quick menu
      const btnActionMenuDialogue = document.getElementById(
        "btnActionMenuDialogue"
      );
      const quickMenuDialogue = document.getElementById("quickMenuDialogue");
      let quickMenuDialogueOpen = false;

      function openQuickMenuDialogue() {
        if (!quickMenuDialogue) return;
        quickMenuDialogue.classList.remove("hidden");
        quickMenuDialogueOpen = true;
        btnActionMenuDialogue?.setAttribute("aria-expanded", "true");
        // Init roving tabindex + focus first
        const items = Array.from(
          quickMenuDialogue.querySelectorAll('.quick-item[role="menuitem"]')
        );
        items.forEach((el, i) =>
          el.setAttribute("tabindex", i === 0 ? "0" : "-1")
        );
        if (items[0]) items[0].focus({ preventScroll: true });
      }
      function closeQuickMenuDialogue() {
        if (!quickMenuDialogue) return;
        quickMenuDialogue.classList.add("hidden");
        quickMenuDialogueOpen = false;
        btnActionMenuDialogue?.setAttribute("aria-expanded", "false");
        btnActionMenuDialogue?.focus({ preventScroll: true });
      }

      if (btnActionMenuDialogue) {
        btnActionMenuDialogue.addEventListener("click", (e) => {
          e.stopPropagation();
          if (isSmallScreen()) {
            if (quickMenuDialogueOpen) closeQuickMenuDialogue();
            else openQuickMenuDialogue();
          }
        });
      }

      if (quickMenuDialogue) {
        const getDialogueItems = () =>
          Array.from(
            quickMenuDialogue.querySelectorAll('.quick-item[role="menuitem"]')
          );

        const moveDialogueFocus = (nextIdx) => {
          const items = getDialogueItems();
          if (!items.length) return;
          const current = document.activeElement;
          let idx = Math.max(
            0,
            items.findIndex((el) => el === current)
          );
          if (Number.isFinite(nextIdx)) {
            idx = ((nextIdx % items.length) + items.length) % items.length;
          }
          items.forEach((el, i) =>
            el.setAttribute("tabindex", i === idx ? "0" : "-1")
          );
          items[idx].focus({ preventScroll: true });
        };

        quickMenuDialogue.addEventListener("keydown", (e) => {
          if (!quickMenuDialogueOpen) return;
          const items = getDialogueItems();
          if (!items.length) return;

          const idx = items.findIndex((el) => el === document.activeElement);

          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              moveDialogueFocus(idx + 1);
              break;
            case "ArrowUp":
              e.preventDefault();
              moveDialogueFocus(idx - 1);
              break;
            case "Home":
              e.preventDefault();
              moveDialogueFocus(0);
              break;
            case "End":
              e.preventDefault();
              moveDialogueFocus(items.length - 1);
              break;
            case "Enter":
            case " ":
              e.preventDefault();
              if (idx >= 0) items[idx].click();
              break;
            case "Escape":
              e.preventDefault();
              closeQuickMenuDialogue();
              break;
            case "Tab":
              // Close menu and allow natural tab order
              closeQuickMenuDialogue();
              break;
          }
        });

        quickMenuDialogue.addEventListener("click", (e) => {
          const item =
            e.target && e.target.closest
              ? e.target.closest(".quick-item")
              : null;
          if (!item) return;
          const action = item.getAttribute("data-menu");
          if (action === "upload") {
            if (filePicker && typeof filePicker.click === "function")
              filePicker.click();
            closeQuickMenuDialogue();
            setActiveTool("chat");
            $("chatInput")?.focus();
            return;
          }
          // Dialogue on mobile should stay as full section
          if (action === "dialogue" && isSmallScreen()) {
            closeQuickMenuDialogue();
            setActiveTool("chat");
            setActive("dialogue");
            return;
          }
          setActiveTool(action);
          closeQuickMenuDialogue();
          $("chatInput")?.focus();
        });
      }

      window.addEventListener("resize", () => {
        if (typeof updateGlobalQuickButtonVisibility === "function") {
          try {
            updateGlobalQuickButtonVisibility();
          } catch {}
        }
      });

      document.addEventListener("click", (e) => {
        // Close desktop tools panel on outside click
        if (toolsPanel && !toolsPanel.classList.contains("hidden")) {
          if (!toolsPanel.contains(e.target) && e.target !== btnActionMenu) {
            closeTools();
          }
        }
        // Close quick menu on outside click
        if (
          quickMenuOpen &&
          quickMenu &&
          !quickMenu.contains(e.target) &&
          e.target !== btnActionMenu
        ) {
          closeQuickMenu();
        }
        // Close dialogue quick menu on outside click
        if (
          quickMenuDialogueOpen &&
          quickMenuDialogue &&
          !quickMenuDialogue.contains(e.target) &&
          e.target !== btnActionMenuDialogue
        ) {
          closeQuickMenuDialogue();
        }
        // Close global quick menu on outside click
        if (
          quickMenuGlobalOpen &&
          quickMenuGlobal &&
          !quickMenuGlobal.contains(e.target) &&
          e.target !== btnActionMenuGlobal
        ) {
          closeQuickMenuGlobal();
        }
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeTools();
          closeQuickMenu();
          closeQuickMenuDialogue();
          closeQuickMenuGlobal();
        }
      });
      if (toolsList) {
        // Mouse/Touch click
        toolsList.addEventListener("click", (e) => {
          const btn =
            e.target && e.target.closest
              ? e.target.closest("[data-tool]")
              : null;
          if (!btn) return;
          const tool = btn.getAttribute("data-tool");
          const isSmall =
            window.matchMedia &&
            window.matchMedia("(max-width: 639px)").matches;

          if (isSmall) {
            // Upload stays inside the tools panel so users see the uploader UI.
            if (tool === "upload") {
              setActiveTool("chat"); // clear any routing
              selectTool("upload"); // keep panel open
              return;
            }
            // Dialogue opens as a full section on mobile
            if (tool === "dialogue") {
              setActiveTool("chat"); // clear composer routing
              closeTools();
              setActive("dialogue");
              return;
            }
            // Other tools: route via main composer (ChatGPT-like), then close panel.
            setActiveTool(tool);
            closeTools();
          } else {
            // Desktop retains rich panel behavior.
            selectTool(tool);
          }
        });

        // Keyboard navigation for tabs (desktop panel)
        toolsList.addEventListener("keydown", (e) => {
          const all = Array.from(
            toolsList.querySelectorAll('[role="tab"][data-tool]')
          );
          if (!all.length) return;
          const focused =
            (document.activeElement &&
              document.activeElement.closest &&
              document.activeElement.closest('[role="tab"][data-tool]')) ||
            all.find((t) => t.getAttribute("aria-selected") === "true") ||
            all[0];
          let idx = all.indexOf(focused);
          if (idx < 0) idx = 0;

          const move = (nextIdx) => {
            const target = all[nextIdx];
            if (!target) return;
            selectTool(target.getAttribute("data-tool"));
            target.focus({ preventScroll: true });
          };

          switch (e.key) {
            case "ArrowRight":
            case "ArrowDown":
              e.preventDefault();
              move((idx + 1) % all.length);
              break;
            case "ArrowLeft":
            case "ArrowUp":
              e.preventDefault();
              move((idx - 1 + all.length) % all.length);
              break;
            case "Home":
              e.preventDefault();
              move(0);
              break;
            case "End":
              e.preventDefault();
              move(all.length - 1);
              break;
          }
        });
      }
      if (toolsBackdrop) {
        toolsBackdrop.addEventListener("click", () => closeTools());
      }

      // Init (Chat first)
      updateActiveToolBadge();
      setComposerPlaceholder();
      setActive("chat");
      renderChat();
      document
        .getElementById("btnClearAttachments")
        ?.addEventListener("click", async () => {
          const ok = confirm("Remove all files from this material?");
          if (!ok) return;
          await clearAllAttachments();
        });

      // ===== Dialogue (coached conversation) =====
      let dialogueSessionId = null;
      let dialogueTopics = [];
      let dialogueIndex = 0;
      let dialogueStarted = false;
      let dialogueLanguage = null;
      let lastCoachQuestion = "";

      // Append a message to the Dialogue stream (bubble style)
      function renderDialogueStreamAppend(role, content) {
        const el = $("dialogueStream");
        if (!el) return;
        const isYou = !(role === "coach" || role === "ilmatrix");
        const who =
          role === "coach" ? "Coach" : role === "ilmatrix" ? "ilmatrix" : "You";
        const body =
          role === "coach" || role === "ilmatrix"
            ? renderMarkdown(content)
            : "<div class='whitespace-pre-wrap break-words text-sm sm:text-base'>" +
              escapeHtml(content) +
              "</div>";

        const bubbleClass =
          (isYou ? "bubble-out" : "bubble-in") +
          " rounded-2xl px-3 py-2 shadow-sm max-w-[85%] transition-all duration-200 ease-out";
        const rowClass = isYou ? "justify-end" : "justify-start";
        const avatar =
          '<div class="avatar shrink-0" aria-hidden="true">' +
          (isYou ? "U" : escapeHtml(who[0])) +
          "</div>";
        const html =
          '<div class="my-2 flex ' +
          rowClass +
          ' items-start gap-2">' +
          (isYou ? "" : avatar) +
          '<div class="' +
          bubbleClass +
          '">' +
          body +
          "</div>" +
          (isYou ? avatar : "") +
          "</div>";
        el.insertAdjacentHTML("beforeend", html);
        addCopyButtons(el);
        el.scrollTop = el.scrollHeight;
      }

      // Reset Dialogue UI state
      function resetDialogueUI() {
        dialogueSessionId = null;
        dialogueTopics = [];
        dialogueIndex = 0;
        dialogueStarted = false;
        dialogueLanguage = null;
        lastCoachQuestion = "";
        const s = $("dialogueStream");
        if (s)
          s.innerHTML =
            "<em class='text-gray-500'>Click Start to begin Dialogue.</em>";
        const start = $("btnDialogueStart");
        const begin = $("btnDialogueBegin");
        const input = $("dialogueInput");
        const send = $("btnDialogueSend");
        const hint = $("btnDialogueHint");
        if (start) start.classList.remove("hidden");
        if (begin) begin.classList.add("hidden");
        if (input) input.value = "";
        if (send) send.disabled = true;
        if (hint) hint.classList.add("hidden");
      }

      // Wire buttons (if the tab exists)
      const btnDialogueStart = $("btnDialogueStart");
      const btnDialogueBegin = $("btnDialogueBegin");
      const btnDialogueSend = $("btnDialogueSend");
      const btnDialogueHint = $("btnDialogueHint");

      if (btnDialogueStart) {
        btnDialogueStart.addEventListener("click", async () => {
          if (!materialId) {
            alert("Upload material first");
            return;
          }
          try {
            const res = await fetch("/api/dialogue/start", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ materialId }),
            });
            const data = await res.json();
            dialogueSessionId = data.sessionId || null;
            dialogueTopics = Array.isArray(data.topics) ? data.topics : [];
            dialogueLanguage = data.language || null;

            // Show opener as "ilmatrix"
            const stream = $("dialogueStream");
            if (stream) stream.innerHTML = "";
            renderDialogueStreamAppend("ilmatrix", data.intro || "");
            lastCoachQuestion = data.firstCoachPrompt || "";
            dialogueStarted = true;

            btnDialogueStart.classList.add("hidden");
            btnDialogueBegin?.classList.remove("hidden");
            if (btnDialogueSend) btnDialogueSend.disabled = true;
            btnDialogueHint?.classList.add("hidden");
          } catch (e) {
            alert("Dialogue start failed: " + e.message);
          }
        });
      }

      if (btnDialogueBegin) {
        btnDialogueBegin.addEventListener("click", () => {
          btnDialogueBegin.classList.add("hidden");
          if (lastCoachQuestion) {
            renderDialogueStreamAppend("coach", lastCoachQuestion);
            if (btnDialogueSend) btnDialogueSend.disabled = false;
            btnDialogueHint?.classList.remove("hidden");
            $("dialogueInput")?.focus();
          }
        });
      }

      async function sendDialogue() {
        if (!dialogueStarted) return;
        const input = $("dialogueInput");
        const msg = (input?.value || "").trim();
        if (!msg) return;
        input.value = "";
        renderDialogueStreamAppend("you", msg);
        try {
          const payload = {
            sessionId: dialogueSessionId || undefined,
            materialId,
            topics: dialogueTopics,
            currentTopicIndex: dialogueIndex,
            userMessage: msg,
            lastCoachQuestion,
            language: dialogueLanguage || undefined,
          };
          const res = await fetch("/api/dialogue/step", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          const coachMsg = data.coachMessage || JSON.stringify(data);
          renderDialogueStreamAppend("coach", coachMsg);

          if (data.moveToNext) {
            dialogueIndex = dialogueIndex + 1;

            // finished all topics
            if (dialogueIndex >= (dialogueTopics?.length || 3)) {
              try {
                const fbRes = await fetch("/api/dialogue/feedback", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    materialId,
                    topics: dialogueTopics,
                    history: [], // optional
                    language: dialogueLanguage || undefined,
                  }),
                });
                const fb = await fbRes.json();
                let block = "";
                if (fb && (fb.feedback || fb.strengths || fb.improvements)) {
                  block += fb.feedback ? fb.feedback + "\n\n" : "";
                  if (Array.isArray(fb.strengths) && fb.strengths.length) {
                    block +=
                      (dialogueLanguage === "id"
                        ? "Kekuatan:\n"
                        : "Strengths:\n") +
                      fb.strengths.map((s) => "- " + s).join("\n") +
                      "\n\n";
                  }
                  if (
                    Array.isArray(fb.improvements) &&
                    fb.improvements.length
                  ) {
                    block +=
                      (dialogueLanguage === "id"
                        ? "Perbaikan:\n"
                        : "Improvements:\n") +
                      fb.improvements.map((s) => "- " + s).join("\n");
                  }
                } else {
                  block = coachMsg;
                }
                renderDialogueStreamAppend("coach", block);
              } catch (e) {
                renderDialogueStreamAppend(
                  "coach",
                  "Feedback error: " + e.message
                );
              }
              if (btnDialogueSend) btnDialogueSend.disabled = true;
              btnDialogueHint?.classList.add("hidden");
              return;
            }

            if (data.nextCoachQuestion) {
              lastCoachQuestion = data.nextCoachQuestion;
              renderDialogueStreamAppend("coach", data.nextCoachQuestion);
            }
          } else {
            if (data.nextCoachQuestion)
              lastCoachQuestion = data.nextCoachQuestion;
          }
        } catch (e) {
          renderDialogueStreamAppend(
            "coach",
            "Dialogue step error: " + e.message
          );
        }
      }

      if (btnDialogueSend) {
        btnDialogueSend.addEventListener("click", sendDialogue);
        $("dialogueInput")?.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendDialogue();
          }
        });
      }

      if (btnDialogueHint) {
        btnDialogueHint.addEventListener("click", async () => {
          if (!dialogueStarted) return;
          const title =
            (dialogueTopics && dialogueTopics[dialogueIndex]?.title) || "";
          try {
            const res = await fetch("/api/dialogue/hint", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                materialId,
                currentTopicTitle: title,
                language: dialogueLanguage || undefined,
              }),
            });
            const data = await res.json();
            const hint = data.hint || JSON.stringify(data);
            renderDialogueStreamAppend(
              "coach",
              (dialogueLanguage === "id" ? "Petunjuk: " : "Hint: ") + hint
            );
          } catch (e) {
            renderDialogueStreamAppend("coach", "Hint error: " + e.message);
          }
        });
      }

      // Authentication Management
      class AuthManager {
        constructor() {
          this.userInfo = document.getElementById('userInfo');
          this.userName = document.getElementById('userName');
          this.btnLogin = document.getElementById('btnLogin');
          this.btnLogout = document.getElementById('btnLogout');
          this.userDropdownBtn = document.getElementById('userDropdownBtn');
          this.userDropdownMenu = document.getElementById('userDropdownMenu');
          
          this.init();
        }

        async init() {
          await this.checkAuthStatus();
          this.attachEventListeners();
        }

        attachEventListeners() {
          if (this.btnLogout) {
            this.btnLogout.addEventListener('click', () => this.logout());
          }

          // User dropdown toggle
          if (this.userDropdownBtn && this.userDropdownMenu) {
            this.userDropdownBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              this.toggleUserDropdown();
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
              if (!this.userDropdownBtn.contains(e.target) && !this.userDropdownMenu.contains(e.target)) {
                this.closeUserDropdown();
              }
            });
          }
        }

        toggleUserDropdown() {
          const isHidden = this.userDropdownMenu.classList.contains('hidden');
          if (isHidden) {
            this.userDropdownMenu.classList.remove('hidden');
            this.userDropdownBtn.setAttribute('aria-expanded', 'true');
            // Rotate chevron
            const chevron = this.userDropdownBtn.querySelector('svg:last-child');
            if (chevron) chevron.style.transform = 'rotate(180deg)';
          } else {
            this.closeUserDropdown();
          }
        }

        closeUserDropdown() {
          this.userDropdownMenu.classList.add('hidden');
          this.userDropdownBtn.setAttribute('aria-expanded', 'false');
          // Reset chevron
          const chevron = this.userDropdownBtn.querySelector('svg:last-child');
          if (chevron) chevron.style.transform = 'rotate(0deg)';
        }

        async checkAuthStatus() {
          try {
            const response = await fetch('/api/auth/profile', {
              credentials: 'include' // Include cookies
            });
            
            if (response.ok) {
              const data = await response.json();
              this.showUserInfo(data.user);
            } else {
              this.showLoginButton();
            }
          } catch (error) {
            console.error('Auth check failed:', error);
            this.showLoginButton();
          }
        }

        showUserInfo(user) {
          if (this.userName) {
            this.userName.textContent = user.name || user.email;
          }
          if (this.userInfo) {
            this.userInfo.classList.remove('hidden');
            this.userInfo.classList.add('flex');
          }
          if (this.btnLogin) {
            this.btnLogin.classList.add('hidden');
          }
          // Show user-only navigation links
          document.querySelectorAll('.userOnlyLink').forEach(link => {
            link.classList.remove('hidden');
          });
          
          // Initialize chat sidebar for authenticated users
          if (!chatSidebar) {
            chatSidebar = new ChatSidebar();
          }
        }

        showLoginButton() {
          if (this.userInfo) {
            this.userInfo.classList.add('hidden');
            this.userInfo.classList.remove('flex');
          }
          if (this.btnLogin) {
            this.btnLogin.classList.remove('hidden');
          }
          // Hide user-only navigation links
          document.querySelectorAll('.userOnlyLink').forEach(link => {
            link.classList.add('hidden');
          });
        }

        async logout() {
          try {
            const response = await fetch('/api/auth/logout', {
              method: 'POST',
              credentials: 'include'
            });
            
            if (response.ok) {
              // Redirect to login page after successful logout
              window.location.href = '/login';
            } else {
              console.error('Logout failed');
              // Still redirect to login page even if logout API fails
              window.location.href = '/login';
            }
          } catch (error) {
            console.error('Logout error:', error);
            // Redirect to login page even on error
            window.location.href = '/login';
          }
        }
      }

      // Initialize auth manager when page loads
      const authManager = new AuthManager();
      
      // Global auth status checker
      async function checkAuthStatus() {
        try {
          const response = await fetch('/api/auth/profile', {
            credentials: 'include'
          });
          
          if (response.ok) {
            const data = await response.json();
            return { isAuthenticated: true, user: data.user };
          } else {
            return { isAuthenticated: false };
          }
        } catch (error) {
          console.error('Auth check failed:', error);
          return { isAuthenticated: false };
        }
      }

      // Chat Sidebar Management
      class ChatSidebar {
        constructor() {
          this.sidebar = document.getElementById('chatSidebar');
          this.overlay = document.getElementById('sidebarOverlay');
          this.toggleBtn = document.getElementById('sidebarToggle');
          this.closeBtn = document.getElementById('closeSidebar');
          this.newChatBtn = document.getElementById('newChatBtn');
          this.sessionsList = document.getElementById('chatSessionsList');
          this.isOpen = false;
          
          this.init();
        }
        
        init() {
          this.attachEventListeners();
          this.loadChatSessions();
        }
        
        attachEventListeners() {
          if (this.toggleBtn) {
            this.toggleBtn.addEventListener('click', () => this.toggle());
          }
          
          if (this.closeBtn) {
            this.closeBtn.addEventListener('click', () => this.close());
          }
          
          if (this.overlay) {
            this.overlay.addEventListener('click', () => this.close());
          }
          
          if (this.newChatBtn) {
            this.newChatBtn.addEventListener('click', () => this.createNewChat());
          }
        }
        
        toggle() {
          if (this.isOpen) {
            this.close();
          } else {
            this.open();
          }
        }
        
        open() {
          // Remove hidden first to allow transition
          this.sidebar.classList.remove('hidden');
          this.overlay.classList.remove('hidden');

          // Force reflow to ensure transition works
          this.sidebar.offsetHeight;
          this.overlay.offsetHeight;

          // Add open classes for transition
          this.sidebar.classList.add('sidebar-open');
          this.overlay.classList.add('overlay-open');

          this.isOpen = true;
          this.loadChatSessions(); // Refresh sessions when opening

          // Prevent body scroll on mobile when sidebar is open
          document.body.style.overflow = 'hidden';
        }

        close() {
          // Remove open classes for transition
          this.sidebar.classList.remove('sidebar-open');
          this.overlay.classList.remove('overlay-open');

          // Wait for transition to complete before hiding
          setTimeout(() => {
            if (!this.isOpen) {
              this.sidebar.classList.add('hidden');
              this.overlay.classList.add('hidden');
            }
          }, 300); // Match transition duration

          this.isOpen = false;

          // Re-enable body scroll
          document.body.style.overflow = '';
        }
        
        async loadChatSessions() {
          try {
            const response = await fetch('/api/dashboard/chat/sessions', {
              credentials: 'include'
            });
            
            if (!response.ok) throw new Error('Failed to load sessions');
            
            const data = await response.json();
            this.renderSessions(data.sessions);
          } catch (error) {
            console.error('Failed to load chat sessions:', error);
            this.sessionsList.innerHTML = '<p class="text-gray-500 p-4 text-sm">Failed to load sessions</p>';
          }
        }
        
        renderSessions(sessions) {
          if (sessions.length === 0) {
            this.sessionsList.innerHTML = '<p class="text-gray-500 p-4 text-sm">No chat sessions yet</p>';
            return;
          }
          
          this.sessionsList.innerHTML = sessions.map(session => `
            <div class="session-item group p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 border border-transparent ${session.id === sessionId ? 'bg-blue-50 dark:bg-blue-900 border-blue-200 dark:border-blue-700' : ''}">
              <div class="flex items-start justify-between">
                <div class="flex-1 cursor-pointer" onclick="chatSidebar.switchToSession('${session.id}')">
                  <div class="font-medium text-sm text-gray-900 dark:text-white truncate">${this.escapeHtml(session.title)}</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${session.messageCount} messages</div>
                  <div class="text-xs text-gray-400 dark:text-gray-500">${this.formatDate(session.updatedAt)}</div>
                </div>
                <div class="flex items-center gap-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button
                    onclick="event.stopPropagation(); chatSidebar.editSession('${session.id}', '${this.escapeHtml(session.title)}')"
                    class="p-1 rounded text-gray-400 hover:text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900"
                    title="Edit title"
                  >
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                  </button>
                  <button
                    onclick="event.stopPropagation(); chatSidebar.deleteSession('${session.id}', '${this.escapeHtml(session.title)}')"
                    class="p-1 rounded text-gray-400 hover:text-red-600 hover:bg-red-100 dark:hover:bg-red-900"
                    title="Delete session"
                  >
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          `).join('');
        }
        
        async switchToSession(sessionIdParam) {
          console.log('[Mobile Debug] switchToSession called with:', sessionIdParam);
          console.log('[Mobile Debug] Current sessionId:', sessionId);

          // Prevent switching to the same session
          if (sessionIdParam === sessionId) {
            console.log('[Mobile Debug] Same session, closing sidebar');
            this.close();
            return;
          }

          try {
            // Show loading state
            const sessionsList = this.sessionsList;
            if (sessionsList) {
              sessionsList.style.opacity = '0.5';
              sessionsList.style.pointerEvents = 'none';
            }

            console.log('[Mobile Debug] Loading session:', sessionIdParam);

            // Load the selected session (state will be reset automatically in loadChatSession)
            const success = await loadChatSession(sessionIdParam);

            console.log('[Mobile Debug] Session loaded:', success);

            // Restore interactivity
            if (sessionsList) {
              sessionsList.style.opacity = '1';
              sessionsList.style.pointerEvents = 'auto';
            }

            if (success) {
              // Refresh the sidebar to highlight the active session
              await this.loadChatSessions();
              console.log('[Mobile Debug] Sidebar refreshed');
            }
          } catch (error) {
            console.error('[Mobile Debug] Error switching session:', error);
            alert('Failed to switch session: ' + error.message);

            // Restore interactivity on error
            const sessionsList = this.sessionsList;
            if (sessionsList) {
              sessionsList.style.opacity = '1';
              sessionsList.style.pointerEvents = 'auto';
            }
          }
        }

        async createNewChat() {
          const title = prompt('Enter chat title:');
          if (!title) return;

          try {
            const response = await fetch('/api/dashboard/chat/sessions', {
              method: 'POST',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ title })
            });

            if (!response.ok) throw new Error('Failed to create session');

            const data = await response.json();

            // CRITICAL FIX: Use switchToSession instead of page reload
            // This ensures state is properly reset
            await this.switchToSession(data.session.id);
          } catch (error) {
            console.error('Failed to create new chat:', error);
            alert('Failed to create new chat session');
          }
        }
        
        async editSession(sessionId, currentTitle) {
          const newTitle = prompt('Edit chat title:', currentTitle);
          if (!newTitle || newTitle === currentTitle) return;
          
          try {
            const response = await fetch(`/api/dashboard/chat/sessions/${sessionId}`, {
              method: 'PUT',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ title: newTitle })
            });
            
            if (!response.ok) throw new Error('Failed to update session');
            
            // Refresh the sessions list
            this.loadChatSessions();
          } catch (error) {
            console.error('Failed to update chat session:', error);
            alert('Failed to update chat session');
          }
        }
        
        async deleteSession(sessionId, title) {
          if (!confirm(`Are you sure you want to delete "${title}"?`)) return;
          
          try {
            const response = await fetch(`/api/dashboard/chat/sessions/${sessionId}`, {
              method: 'DELETE',
              credentials: 'include'
            });
            
            if (!response.ok) throw new Error('Failed to delete session');
            
            // If we deleted the current session, redirect to main app
            const urlParams = new URLSearchParams(window.location.search);
            const currentSessionId = urlParams.get('sessionId');
            
            if (currentSessionId === sessionId) {
              window.location.href = '/app';
            } else {
              // Just refresh the sessions list
              this.loadChatSessions();
            }
          } catch (error) {
            console.error('Failed to delete chat session:', error);
            alert('Failed to delete chat session');
          }
        }
        
        escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
        
        formatDate(dateString) {
          const date = new Date(dateString);
          const now = new Date();
          const diffMs = now - date;
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const diffDays = Math.floor(diffHours / 24);

          if (diffHours < 1) return 'Just now';
          if (diffHours < 24) return `${diffHours}h ago`;
          if (diffDays < 7) return `${diffDays}d ago`;
          return date.toLocaleDateString();
        }
      }
      
      // Initialize chat sidebar for authenticated users
      let chatSidebar = null;
      // Will be initialized after auth check

      // Guest Usage Management
      function updateGuestUsageDisplay(headers) {
        const authStatus = headers.get('X-Auth-Status');
        const current = headers.get('X-Guest-Usage-Current');
        const max = headers.get('X-Guest-Usage-Max');
        const remaining = headers.get('X-Guest-Usage-Remaining');
        const warning = headers.get('X-Guest-Warning');
        
        const counter = document.getElementById('guestUsageCounter');
        const text = document.getElementById('guestUsageText');
        
        if (authStatus === 'guest' && current && max) {
          // Show guest usage counter
          counter.classList.remove('hidden');
          counter.classList.add('flex');
          text.textContent = `${current}/${max} uses`;
          
          // Change color when approaching limit
          if (warning === 'true' || remaining <= 1) {
            counter.className = counter.className.replace('bg-orange-600/80', 'bg-red-600/80');
          }
        } else if (authStatus === 'authenticated') {
          // Hide counter for authenticated users
          counter.classList.add('hidden');
          counter.classList.remove('flex');
        }
      }
      
      function handleGuestLimitReached(errorData, targetElement = null) {
        // Show limit reached message in target element if provided
        if (targetElement) {
          targetElement.innerHTML = `
            <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-lg text-center">
              <div class="mb-4">
                <svg class="w-12 h-12 mx-auto text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.232 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-bold mb-2">Trial Limit Reached! üöÄ</h3>
              <p class="mb-4">You've used all 5 free AI features. Create a free account to continue using ILMATRIX!</p>
              <div class="space-y-2">
                <a href="/login" class="inline-block bg-white text-red-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition-colors">
                  Login / Sign Up
                </a>
                <p class="text-sm text-yellow-100">‚ú® Unlimited access with a free account</p>
              </div>
            </div>
          `;
        }
        
        // Show modal/alert
        showGuestLimitModal(errorData);
      }
      
      function showGuestLimitModal(errorData) {
        // Create modal overlay
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
          <div class="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full p-6 text-center">
            <div class="mb-4">
              <div class="w-16 h-16 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.232 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
              </div>
              <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Trial Limit Reached!</h2>
              <p class="text-gray-600 dark:text-gray-300 mb-6">${errorData.error || 'You\'ve used all 5 free AI features. Create a free account to continue!'}</p>
            </div>
            
            <div class="space-y-3">
              <a href="/login" class="block w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium py-3 px-6 rounded-lg hover:opacity-90 transition-opacity">
                Create Free Account
              </a>
              <button onclick="closeGuestModal()" class="block w-full text-gray-600 dark:text-gray-400 font-medium py-2 px-6 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                Close
              </button>
            </div>
            
            <div class="mt-4 text-sm text-gray-500 dark:text-gray-400 space-y-1">
              <p>‚ú® <strong>Free account benefits:</strong></p>
              <p>‚Ä¢ Unlimited AI features</p>
              <p>‚Ä¢ Save your materials</p>
              <p>‚Ä¢ Access history</p>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeGuestModal();
          }
        });
        
        // Store modal reference for closing
        window.currentGuestModal = modal;
      }
      
      function closeGuestModal() {
        if (window.currentGuestModal) {
          document.body.removeChild(window.currentGuestModal);
          window.currentGuestModal = null;
        }
      }
      
    </script>
  </body>
</html>
