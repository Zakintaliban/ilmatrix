<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="./logo.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ILMATRIX — App</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#0f0e85",
              secondary: "#e44c99",
              tertiary: "#1b612f",
            },
          },
        },
      };
    </script>
    <!-- SEO meta -->
    <link rel="canonical" href="/app.html" />
    <meta
      name="description"
      content="ILMATRIX App — Upload PDF, DOCX, PPTX, or images. Explain with citations, generate MCQ quizzes with deterministic grading, create flashcards, draft forum replies, prepare for exams, and chat with context."
    />
    <meta
      name="keywords"
      content="ILMATRIX app, study AI, quiz generator, MCQ, flashcards, explain material, forum reply, exam helper, OCR, PDF to text, DOCX, PPTX, university, belajar, kuliah"
    />
    <meta
      name="robots"
      content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1"
    />
    <meta name="author" content="ILMATRIX" />
    <meta name="theme-color" content="#0f0e85" />
    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="ILMATRIX — App (Explain, MCQ, Flashcards, Forum, Exam, Chat)"
    />
    <meta
      property="og:description"
      content="Study companion grounded in your materials. Explain, MCQ with deterministic grading, flashcards, forum replies, exam helper, and chat."
    />
    <meta property="og:url" content="/app.html" />
    <meta property="og:image" content="/logo.svg" />
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="ILMATRIX — App" />
    <meta
      name="twitter:description"
      content="Explain, MCQ, Flashcards, Forum, Exam — grounded in your materials."
    />
    <meta name="twitter:image" content="/logo.svg" />
    <!-- hreflang -->
    <link rel="alternate" href="/app.html" hreflang="en" />
    <link rel="alternate" href="/app.html" hreflang="x-default" />

    <!-- Structured data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
          { "@type": "ListItem", "position": 1, "name": "Home", "item": "/" },
          {
            "@type": "ListItem",
            "position": 2,
            "name": "App",
            "item": "/app.html"
          }
        ]
      }
    </script>
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "ILMATRIX",
        "applicationCategory": "EducationalApplication",
        "operatingSystem": "Web",
        "url": "/app.html",
        "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" }
      }
    </script>
    <!-- Markdown renderer + sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

    <style>
      html {
        scroll-behavior: smooth;
      }
      /* Flashcard flip styles */
      .fc-scene {
        perspective: 1000px;
      }
      .fc-card {
        position: relative;
        width: 100%;
        height: 11rem; /* ~h-44 */
        transform-style: preserve-3d;
        transition: transform 0.6s;
        cursor: pointer;
        -webkit-user-select: none;
        user-select: none;
      }
      @media (min-width: 640px) {
        .fc-card {
          height: 12rem;
        } /* sm:h-48 */
      }
      .fc-card.is-flipped {
        transform: rotateY(180deg);
      }
      /* Mobile-friendly global clamps */
      html,
      body {
        max-width: 100%;
        overflow-x: hidden;
      }
      .markdown {
        word-break: break-word;
        overflow-wrap: anywhere;
        max-width: 100%;
      }
      /* Attachments container mobile fixes */
      #attachments {
        max-width: 100%;
      }
      #attachments .truncate {
        min-width: 0;
      }
      #attachments .font-medium {
        word-break: break-word;
        overflow-wrap: anywhere;
      }
      #attachments .btnRemove {
        flex-shrink: 0;
      }
      .markdown img {
        max-width: 100%;
        height: auto;
      }
      .markdown table {
        width: 100%;
        display: block;
        overflow-x: auto;
      }
      .markdown pre {
        max-width: 100%;
        overflow: auto;
      }

      /* Attachments list responsive helpers */
      .attachments-item .left {
        min-width: 0;
      }
      .attachments-item .right {
        flex-shrink: 0;
      }
      .fc-face {
        position: absolute;
        inset: 0;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        border-radius: 0.75rem; /* rounded-xl */
        border: 1px solid rgb(229 231 235); /* ring-gray-200 */
        background: white;
        padding: 0.75rem; /* p-3 */
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }
      .fc-front {
        color: rgb(17 24 39); /* gray-900 */
        font-weight: 600;
      }
      .fc-back {
        transform: rotateY(180deg);
        color: rgb(31 41 55); /* gray-800 */
      }
      .fc-hint {
        position: absolute;
        bottom: 0.5rem;
        left: 0.5rem;
        right: 0.5rem;
        font-size: 0.75rem;
        color: rgb(107 114 128); /* gray-500 */
        opacity: 0.85;
      }

      /* Basic markdown rendering */
      .markdown h1,
      .markdown h2,
      .markdown h3 {
        font-weight: 700;
        margin: 0.75rem 0 0.5rem;
      }
      .markdown p {
        margin: 0.5rem 0;
      }
      .markdown ul,
      .markdown ol {
        margin: 0.5rem 1.25rem;
        padding-left: 1rem;
      }
      .markdown code {
        background: #f3f4f6;
        padding: 0.15rem 0.35rem;
        border-radius: 0.25rem;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
      .markdown pre {
        background: #111827;
        color: #e5e7eb;
        padding: 0.75rem;
        border-radius: 0.5rem;
        overflow: auto;
      }
      .markdown blockquote {
        border-left: 4px solid #e5e7eb;
        padding-left: 0.75rem;
        color: #6b7280;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <!-- Header -->
    <header class="bg-primary text-white">
      <div
        class="container mx-auto max-w-6xl px-4 py-4 flex items-center justify-between"
      >
        <a href="/" class="text-xl sm:text-2xl font-bold tracking-tight"
          >ILMATRIX</a
        >
        <div class="flex items-center gap-2">
          <nav class="hidden sm:flex items-center gap-2">
            <a
              href="/app.html"
              class="text-xs sm:text-sm px-3 py-2 rounded-md hover:bg-indigo-900"
              >App</a
            >
            <a
              href="/about.html"
              class="text-xs sm:text-sm px-3 py-2 rounded-md hover:bg-indigo-900"
              >About</a
            >
          </nav>
          <button
            id="btnHealth"
            class="text-xs sm:text-sm bg-secondary hover:bg-pink-500 transition text-white px-3 py-2 rounded-md"
          >
            Check API
          </button>
        </div>
      </div>
    </header>

    <!-- Nav -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-10">
      <div class="container mx-auto max-w-6xl px-4 overflow-x-auto">
        <ul class="flex gap-2 sm:gap-3 py-2 text-sm">
          <li>
            <button
              data-tab="chat"
              class="tab-btn px-3 py-2 rounded-md bg-primary text-white hover:bg-indigo-900"
            >
              Chat
            </button>
          </li>
          <li>
            <button
              data-tab="upload"
              class="tab-btn px-3 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
            >
              Upload
            </button>
          </li>
          <li>
            <button
              data-tab="explain"
              class="tab-btn px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
            >
              Explain
            </button>
          </li>
          <li>
            <button
              data-tab="quiz"
              class="tab-btn px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
            >
              Quiz
            </button>
          </li>
          <li>
            <button
              data-tab="forum"
              class="tab-btn px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
            >
              Forum
            </button>
          </li>
          <li>
            <button
              data-tab="exam"
              class="tab-btn px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
            >
              Exam
            </button>
          </li>
          <li>
            <button
              data-tab="flashcards"
              class="tab-btn px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
            >
              Flashcards
            </button>
          </li>
          <li>
            <button
              data-tab="dialogue"
              class="tab-btn px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
            >
              Dialogue
            </button>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main -->
    <main class="container mx-auto max-w-6xl px-4 py-6 space-y-6">
      <!-- Chat (General) -->
      <section
        id="sec-chat"
        class="card bg-white rounded-xl shadow-sm ring-1 ring-gray-200"
      >
        <div class="p-5 sm:p-6">
          <h2 class="text-lg sm:text-xl font-semibold text-primary mb-4">
            Chat (General)
          </h2>
          <div
            id="chat"
            class="w-full rounded-md border border-gray-200 bg-gray-50 p-3 sm:p-4 min-h-[120px] max-h-[300px] overflow-auto text-sm"
          ></div>
          <div class="mt-3 flex gap-2">
            <input
              id="chatInput"
              type="text"
              placeholder="Tulis pesan..."
              aria-label="Chat input"
              class="flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm"
            />
            <button
              id="btnSend"
              class="inline-flex items-center justify-center px-4 py-2 rounded-md bg-primary text-white font-medium hover:bg-indigo-900 transition"
            >
              Send
            </button>
          </div>
        </div>
      </section>

      <!-- Upload -->
      <section
        id="sec-upload"
        class="card bg-white rounded-xl shadow-sm ring-1 ring-gray-200"
      >
        <div class="p-5 sm:p-6">
          <h2 class="text-lg sm:text-xl font-semibold text-primary mb-4">
            Upload Material (PDF / TXT / PNG / JPG / DOCX / PPTX)
          </h2>

          <!-- Header bar: current material + actions -->
          <div class="flex flex-wrap items-center gap-3 mb-3">
            <div class="text-sm text-gray-700">
              Current material:
              <span id="currentMaterialLabel" class="font-semibold text-primary"
                >none</span
              >
            </div>
            <button
              id="btnNewMaterial"
              class="px-3 py-1.5 rounded-md border border-gray-300 text-sm bg-white hover:bg-gray-50"
              title="Start a new material (does not delete existing one)"
            >
              Start new material
            </button>
            <span id="uploadInfo" class="text-sm text-gray-600"></span>
          </div>

          <!-- Hidden multi-file picker (triggered by clicking the drop zone) -->
          <input
            id="filePicker"
            class="hidden"
            type="file"
            multiple
            aria-label="Select files"
            accept=".pdf,.txt,.png,.jpg,.jpeg,.docx,.pptx,image/*,application/pdf,text/plain,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.presentationml.presentation"
          />

          <!-- Drop zone (click or drag & drop) -->
          <div
            id="dropZone"
            class="rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 hover:bg-gray-100 transition p-4 sm:p-6 text-center cursor-pointer"
            role="button"
            tabindex="0"
            aria-label="Drop files here or click to select"
          >
            <p class="font-medium text-gray-800">Drag & drop files here</p>
            <p class="text-xs text-gray-500">
              or click to select. Accepted: PDF, TXT, PNG/JPG, DOCX, PPTX. Total
              limit 10 MB per material.
            </p>
          </div>

          <!-- Attachments list -->
          <div id="attachments" class="mt-4 grid gap-2">
            <em class="text-gray-500"
              >No files yet. Drop or click to upload.</em
            >
          </div>
        </div>
      </section>

      <!-- Explain -->
      <section
        id="sec-explain"
        class="card hidden bg-white rounded-xl shadow-sm ring-1 ring-gray-200"
      >
        <div class="p-5 sm:p-6">
          <h2 class="text-lg sm:text-xl font-semibold text-primary mb-4">
            Explain Material
          </h2>
          <label
            for="promptExplain"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Prompt / Notes</label
          >
          <textarea
            id="promptExplain"
            rows="4"
            class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
            placeholder="Jelaskan bab 2..."
          ></textarea>
          <div class="mt-3">
            <button
              id="btnExplain"
              class="px-4 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
            >
              Run Explain
            </button>
          </div>
          <div
            id="explainResult"
            class="mt-4 text-sm bg-gray-50 border border-gray-200 rounded-md p-3 whitespace-pre-wrap break-words overflow-x-auto"
          ></div>
        </div>
      </section>

      <!-- Quiz (Merged: generate + answer + grade) -->
      <section
        id="sec-quiz"
        class="card hidden bg-white rounded-xl shadow-sm ring-1 ring-gray-200"
      >
        <div class="p-5 sm:p-6 space-y-4">
          <h2 class="text-lg sm:text-xl font-semibold text-primary mb-2">
            Quiz (MCQ) — Generate • Answer • Grade
          </h2>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="flex flex-col">
              <label
                for="numQuestions"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Number of questions</label
              >
              <input
                id="numQuestions"
                type="number"
                min="1"
                max="20"
                value="5"
                class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                placeholder="5"
                aria-label="Number of generated quiz questions"
              />
            </div>
            <div class="flex items-end">
              <button
                id="btnGenerateQuizMCQ"
                class="px-4 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
              >
                Generate MCQ
              </button>
            </div>
          </div>

          <div id="quizMCQ" class="space-y-4"></div>

          <div class="space-y-2">
            <label
              for="quizAnswers"
              class="block text-sm font-medium text-gray-700"
              >Your Answers (format per line: 1 a, 2 b, ...)</label
            >
            <textarea
              id="quizAnswers"
              rows="4"
              class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              placeholder="1 a&#10;2 b&#10;3 c&#10;4 d&#10;5 e"
            ></textarea>
            <div>
              <button
                id="btnSubmitQuizMCQ"
                class="px-4 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
              >
                Submit & Grade
              </button>
            </div>
          </div>

          <div
            id="quizResult"
            class="text-sm bg-gray-50 border border-gray-200 rounded-md p-3 whitespace-pre-wrap break-words overflow-x-auto"
          ></div>
        </div>
      </section>

      <!-- Forum -->
      <section
        id="sec-forum"
        class="card hidden bg-white rounded-xl shadow-sm ring-1 ring-gray-200"
      >
        <div class="p-5 sm:p-6">
          <h2 class="text-lg sm:text-xl font-semibold text-primary mb-4">
            Forum Reply
          </h2>
          <label
            for="promptForum"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Prompt</label
          >
          <textarea
            id="promptForum"
            rows="4"
            class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
            placeholder="Pertanyaan/Topik forum..."
          ></textarea>
          <div class="mt-3">
            <button
              id="btnForum"
              class="px-4 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
            >
              Draft Reply
            </button>
          </div>
          <div
            id="forumResult"
            class="mt-4 text-sm bg-gray-50 border border-gray-200 rounded-md p-3 whitespace-pre-wrap break-words overflow-x-auto"
          ></div>
        </div>
      </section>

      <!-- Exam -->
      <section
        id="sec-exam"
        class="card hidden bg-white rounded-xl shadow-sm ring-1 ring-gray-200"
      >
        <div class="p-5 sm:p-6">
          <h2 class="text-lg sm:text-xl font-semibold text-primary mb-4">
            Exam Helper
          </h2>
          <label
            for="promptExam"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Prompt</label
          >
          <textarea
            id="promptExam"
            rows="4"
            class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
            placeholder="Petunjuk / pertanyaan terkait exam..."
          ></textarea>
          <div class="mt-3">
            <button
              id="btnExam"
              class="px-4 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
            >
              Run Exam Helper
            </button>
          </div>
          <div
            id="examResult"
            class="mt-4 text-sm bg-gray-50 border border-gray-200 rounded-md p-3 whitespace-pre-wrap break-words overflow-x-auto"
          ></div>
        </div>
      </section>

      <!-- Flashcards -->
      <section
        id="sec-flashcards"
        class="card hidden bg-white rounded-xl shadow-sm ring-1 ring-gray-200"
      >
        <div class="p-5 sm:p-6 space-y-4">
          <h2 class="text-lg sm:text-xl font-semibold text-primary">
            Flashcards
          </h2>

          <div class="flex flex-wrap gap-3 items-end">
            <div>
              <label for="numCards" class="block text-xs text-gray-600"
                >Number of flashcards</label
              >
              <input
                id="numCards"
                type="number"
                min="1"
                max="50"
                value="5"
                class="w-28 rounded-md border border-gray-300 px-2 py-2 text-sm"
                placeholder="5"
                aria-label="Number of flashcards"
              />
            </div>
            <button
              id="btnGenerateCards"
              class="px-3 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
            >
              Generate Flashcards
            </button>
          </div>

          <div
            id="flashcardsList"
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
          ></div>
        </div>
      </section>
      <!-- Dialogue -->
      <section
        id="sec-dialogue"
        class="card hidden bg-white rounded-xl shadow-sm ring-1 ring-gray-200"
      >
        <div class="p-5 sm:p-6">
          <div class="flex items-start justify-between gap-2">
            <h2 class="text-lg sm:text-xl font-semibold text-primary">
              Dialogue
            </h2>
            <button
              id="btnDialogueHint"
              class="hidden text-xs sm:text-sm border border-gray-300 px-3 py-1.5 rounded-md hover:bg-gray-50"
              title="Get a hint for the current topic"
            >
              I'm stuck
            </button>
          </div>

          <p class="text-sm text-gray-600 mt-1">
            Guided, topic-based coaching grounded in your uploaded material.
          </p>

          <div class="mt-4 flex items-center gap-3">
            <button
              id="btnDialogueStart"
              class="px-3 py-2 rounded-md bg-secondary text-white hover:bg-pink-500"
            >
              Start
            </button>
            <button
              id="btnDialogueBegin"
              class="hidden px-3 py-2 rounded-md bg-tertiary text-white hover:bg-green-700"
            >
              Let's get started!
            </button>
          </div>

          <div
            id="dialogueStream"
            class="mt-4 text-sm bg-gray-50 border border-gray-200 rounded-md p-3 markdown"
          >
            <em class="text-gray-500">Click Start to begin Dialogue.</em>
          </div>

          <div class="mt-3 flex gap-2 items-start">
            <textarea
              id="dialogueInput"
              class="flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm"
              rows="2"
              placeholder="Type your answer (tip: ask 'How am I doing?')"
            ></textarea>
            <button
              id="btnDialogueSend"
              class="px-4 py-2 rounded-md bg-primary text-white font-medium hover:bg-indigo-900 disabled:opacity-50"
              disabled
            >
              Send
            </button>
          </div>
        </div>
      </section>
    </main>

    <footer class="border-t border-gray-200">
      <div class="container mx-auto max-w-6xl px-4 py-6 text-xs text-gray-500">
        Theme colors:
        <span class="font-medium text-primary">Resistance Blue</span> ·
        <span class="font-medium text-secondary">Brave Pink</span> ·
        <span class="font-medium text-tertiary">Hero Green</span>
      </div>
      <div class="container mx-auto max-w-6xl px-4 py-6 text-xs text-gray-500">
        <p>Made with ❤️ by ILMATRIX</p>
      </div>
    </footer>

    <script>
      // State
      let materialId = null;
      let chat = [];
      let mcqQuestions = [];

      // Helpers
      const $ = (id) => document.getElementById(id);
      const escapeHtml = (s) =>
        String(s).replace(
          /[&<>]/g,
          (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c])
        );

      // Render Markdown safely using marked + DOMPurify (fallback to escaping)
      function renderMarkdown(s) {
        try {
          const src = String(s ?? "");
          const parsed = window.marked
            ? window.marked.parse(src)
            : escapeHtml(src);
          const safe = window.DOMPurify
            ? window.DOMPurify.sanitize(parsed)
            : parsed;
          return "<div class='markdown'>" + safe + "</div>";
        } catch (e) {
          return (
            "<pre class='whitespace-pre-wrap break-words text-sm sm:text-base'><code>" +
            escapeHtml(String(s ?? "")) +
            "</code></pre>"
          );
        }
      }

      // Tabs
      const tabs = [
        "chat",
        "upload",
        "explain",
        "quiz",
        "forum",
        "exam",
        "flashcards",
        "dialogue",
      ];
      function setActive(tab) {
        tabs.forEach((t) => {
          const sec = $("sec-" + t);
          const btns = document.querySelectorAll(
            '.tab-btn[data-tab="' + t + '"]'
          );
          if (sec) sec.classList.toggle("hidden", t !== tab);
          // active decoration (no color override)
          btns.forEach((b) => b.classList.toggle("ring-2", t === tab));
          btns.forEach((b) => b.classList.toggle("ring-offset-2", t === tab));
          btns.forEach((b) => b.classList.toggle("ring-gray-300", t === tab));
          btns.forEach((b) => b.classList.toggle("font-semibold", t === tab));
        });
        // Focus on first focusable inside section
        const firstFocus = document.querySelector(
          "#sec-" +
            tab +
            " input, #sec-" +
            tab +
            " textarea, #sec-" +
            tab +
            " select, #sec-" +
            tab +
            " button"
        );
        if (firstFocus) firstFocus.focus({ preventScroll: true });
      }
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => setActive(btn.dataset.tab));
      });

      // Renderers
      function renderChat() {
        const parts = chat.map((m) => {
          const who =
            m.role === "assistant"
              ? "AI"
              : m.role === "system"
              ? "System"
              : "You";
          const label =
            '<div class="text-xs text-gray-500 font-semibold mb-1">' +
            who +
            ":</div>";
          const body =
            m.role === "assistant"
              ? renderMarkdown(m.content)
              : "<div class='whitespace-pre-wrap break-words text-sm sm:text-base'>" +
                escapeHtml(m.content) +
                "</div>";
          return '<div class="my-2">' + label + body + "</div>";
        });
        const html = parts.join("");
        $("chat").innerHTML =
          html || "<em>Mulai chat dengan mengetik pesan…</em>";
        $("chat").scrollTop = $("chat").scrollHeight;
      }

      // Health
      $("btnHealth").onclick = async () => {
        try {
          const res = await fetch("/api/health");
          const data = await res.json().catch(() => ({}));
          alert("Health: " + JSON.stringify(data));
        } catch (e) {
          alert("Health request failed: " + e.message);
        }
      };

      // Upload — ChatGPT-like drop zone (auto-upload on select/drag-drop)
      const dropZone = $("dropZone");
      const filePicker = $("filePicker");
      const uploadInfo = $("uploadInfo");
      const attachments = $("attachments");
      const currentMaterialLabel = $("currentMaterialLabel");

      function setCurrentMaterialLabel() {
        currentMaterialLabel.textContent = materialId ? materialId : "none";
      }

      function bytesToHuman(n) {
        const units = ["B", "KB", "MB", "GB"];
        let i = 0;
        let v = Number(n || 0);
        while (v >= 1024 && i < units.length - 1) {
          v /= 1024;
          i++;
        }
        return `${v.toFixed(v < 10 && i > 0 ? 1 : 0)} ${units[i]}`;
      }

      function renderAttachmentsList(files, totalSize) {
        if (!files || !files.length) {
          attachments.innerHTML =
            "<em class='text-gray-500'>No files yet. Drop or click to upload.</em>";
        } else {
          const html = files
            .map((f) => {
              const name = String(f.name || "");
              const size = bytesToHuman(f.size || 0);
              const occ = Number(f.occurrences || 0);
              const occText = occ > 1 ? ` ×${occ}` : "";
              return `
                <div class="flex items-center justify-between rounded-md border border-gray-200 bg-white px-3 py-2">
                  <div class="truncate">
                    <span class="font-medium">${escapeHtml(name)}</span>
                    <span class="ml-2 text-xs text-gray-500">${size}${occText}</span>
                  </div>
                  <button
                    class="btnRemove text-xs px-2 py-1 rounded-md border border-gray-300 hover:bg-gray-50"
                    data-name="${encodeURIComponent(name)}"
                    title="Remove this file from material (destructive)"
                  >
                    Remove
                  </button>
                </div>
              `;
            })
            .join("");
          attachments.innerHTML = html;
        }
        if (typeof totalSize === "number") {
          uploadInfo.textContent = `Total size: ${bytesToHuman(
            totalSize
          )} (limit 10 MB)`;
        }
      }

      async function refreshMaterialList() {
        setCurrentMaterialLabel();
        if (!materialId) {
          attachments.innerHTML =
            "<em class='text-gray-500'>No files yet. Drop or click to upload.</em>";
          uploadInfo.textContent = "";
          return;
        }
        try {
          const res = await fetch(`/api/material/${materialId}`);
          const data = await res.json();
          const files = Array.isArray(data.files) ? data.files : [];
          renderAttachmentsList(files, data.totalSize || 0);
        } catch (e) {
          uploadInfo.textContent = "List failed: " + e.message;
        }
      }

      async function autoUpload(selected) {
        const files = Array.from(selected || []).filter((f) => !!f);
        if (!files.length) return;
        const fd = new FormData();
        for (const f of files) fd.append("file", f);

        const doAppend = !!materialId;
        if (doAppend) {
          fd.append("append", "true");
          fd.append("mergeTo", materialId);
        }

        uploadInfo.textContent = `Uploading ${files.length} file(s)...`;
        try {
          const res = await fetch("/api/upload", { method: "POST", body: fd });
          const data = await res.json();
          if (data.materialId) {
            materialId = data.materialId;
            setCurrentMaterialLabel();
            uploadInfo.textContent = `Uploaded ${data.files} file(s). size=${
              data.size
            } ${data.sizeAdded ? "(+" + data.sizeAdded + ")" : ""} limit=${
              data.limit
            }`;
            await refreshMaterialList();
          } else {
            uploadInfo.textContent = "Upload error: " + JSON.stringify(data);
          }
        } catch (e) {
          uploadInfo.textContent = "Upload failed: " + e.message;
        }
      }

      // Click on drop zone opens file picker
      if (dropZone) {
        dropZone.addEventListener(
          "click",
          () => filePicker && filePicker.click()
        );
        dropZone.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            filePicker && filePicker.click();
          }
        });
        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("ring-2", "ring-gray-300");
        });
        dropZone.addEventListener("dragleave", () => {
          dropZone.classList.remove("ring-2", "ring-gray-300");
        });
        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          dropZone.classList.remove("ring-2", "ring-gray-300");
          const dt = e.dataTransfer;
          const files = dt && dt.files ? Array.from(dt.files) : [];
          if (files.length) autoUpload(files);
        });
      }

      // File picker change -> auto upload
      if (filePicker) {
        filePicker.addEventListener("change", () => {
          const files = Array.from(filePicker.files || []);
          // reset value so same file can be selected again later
          filePicker.value = "";
          if (files.length) autoUpload(files);
        });
      }

      // Remove attachment (delegated)
      if (attachments) {
        attachments.addEventListener("click", async (e) => {
          const btn =
            e.target && e.target.closest
              ? e.target.closest(".btnRemove")
              : null;
          if (!btn) return;
          if (!materialId) return;
          const name = decodeURIComponent(btn.getAttribute("data-name") || "");
          if (!name) return;
          uploadInfo.textContent = `Removing ${name}...`;
          try {
            const res = await fetch(`/api/material/${materialId}/remove`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name }),
            });
            const data = await res.json();
            if (data && data.materialId) {
              uploadInfo.textContent = `Removed "${name}". Total size: ${bytesToHuman(
                data.totalSize || 0
              )}`;
              await refreshMaterialList();
            } else {
              uploadInfo.textContent = "Remove error: " + JSON.stringify(data);
            }
          } catch (err) {
            uploadInfo.textContent = "Remove failed: " + err.message;
          }
        });
      }

      // Start new material (client-side reset; does not delete existing server files)
      $("btnNewMaterial").onclick = () => {
        materialId = null;
        setCurrentMaterialLabel();
        attachments.innerHTML =
          "<em class='text-gray-500'>New material. Drop or click to upload.</em>";
        uploadInfo.textContent = "";
      };

      // Initial render
      setCurrentMaterialLabel();
      // No material at first; keep empty list text

      // Shared runner to show JSON or answer into a target element
      async function runAndShow(endpoint, payload, targetId) {
        const el = $(targetId);
        if (!el) return;
        el.innerHTML = '<em class="text-gray-500">Processing...</em>';
        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (data && typeof data.answer === "string" && data.answer.trim()) {
            el.innerHTML = renderMarkdown(data.answer);
          } else {
            el.innerHTML =
              "<pre class='whitespace-pre-wrap break-words text-sm sm:text-base'><code>" +
              escapeHtml(JSON.stringify(data, null, 2)) +
              "</code></pre>";
          }
        } catch (e) {
          el.innerHTML =
            "<pre class='whitespace-pre-wrap break-words text-sm sm:text-base text-red-700'><code>" +
            escapeHtml(e.message) +
            "</code></pre>";
        }
      }

      // Render MCQ UI into a given container
      function renderMCQ(questions, containerId) {
        const container = $(containerId);
        if (!container) return;
        if (!questions || !questions.length) {
          container.innerHTML =
            "<em class='text-gray-500'>No questions yet.</em>";
          return;
        }
        const letters = ["A", "B", "C", "D", "E"];
        const html = questions
          .map((q, qi) => {
            const opts = (q.options || [])
              .slice(0, 5)
              .map((opt, oi) => {
                const letter = letters[oi];
                return (
                  '<div class="pl-1 text-sm"><strong>' +
                  letter +
                  ".</strong> " +
                  escapeHtml(opt) +
                  "</div>"
                );
              })
              .join("");
            return (
              '<div class="rounded-md border border-gray-200 bg-white p-3">' +
              '<div class="font-medium">' +
              (qi + 1) +
              ") " +
              escapeHtml(q.question) +
              "</div>" +
              '<div class="mt-1 grid gap-1">' +
              opts +
              "</div></div>"
            );
          })
          .join("");
        container.innerHTML = html;
      }

      // Explain
      $("btnExplain").onclick = async () => {
        if (!materialId) {
          alert("Upload material first");
          setActive("upload");
          return;
        }
        const prompt = $("promptExplain").value || "";
        await runAndShow(
          "/api/explain",
          { materialId, prompt },
          "explainResult"
        );
      };

      // QUIZ — Generate MCQ
      $("btnGenerateQuizMCQ").onclick = async () => {
        if (!materialId) {
          alert("Upload material first");
          setActive("upload");
          return;
        }
        const n = Number($("numQuestions").value || 5);
        const containerId = "quizMCQ";
        $(containerId).innerHTML =
          "<em class='text-gray-500'>Generating...</em>";
        $("quizResult").textContent = "";
        $("quizAnswers").value = "";
        mcqQuestions = [];
        try {
          const res = await fetch("/api/quiz/trainer/mcq/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ materialId, numQuestions: n }),
          });
          const data = await res.json();
          mcqQuestions = Array.isArray(data.questions) ? data.questions : [];
          renderMCQ(mcqQuestions, containerId);
        } catch (e) {
          $(containerId).innerHTML = "Error: " + e.message;
        }
      };

      // QUIZ — Submit simple text answers: "1 a", "2 b", ...
      $("btnSubmitQuizMCQ").onclick = async () => {
        if (!materialId) {
          alert("Upload material first");
          setActive("upload");
          return;
        }
        if (!mcqQuestions || mcqQuestions.length === 0) {
          alert("Generate quiz first");
          return;
        }
        const raw = ($("quizAnswers").value || "").trim();
        if (!raw) {
          alert("Isi jawaban dulu, contoh:\n1 a\n2 b\n3 c");
          return;
        }
        // Parse lines: "<index> <letter>"
        const lines = raw.split(/\r?\n/);
        const userAnswers = {};
        const missing = [];
        for (let i = 0; i < mcqQuestions.length; i++) {
          const idx = i + 1; // displayed number
          const q = mcqQuestions[i];
          const line = lines.find((ln) =>
            new RegExp("^\\s*" + idx + "\\s+([a-eA-E])\\s*$").test(ln)
          );
          if (!line) {
            missing.push(idx);
            continue;
          }
          const m = line.match(/([a-eA-E])/);
          if (m) userAnswers[q.id] = m[1].toUpperCase();
        }
        if (missing.length) {
          alert("Jawab semua nomor: " + missing.join(", "));
          return;
        }
        $("quizResult").textContent = "Scoring...";
        try {
          const res = await fetch("/api/quiz/trainer/mcq/score", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              materialId,
              questions: mcqQuestions,
              userAnswers,
            }),
          });
          const data = await res.json();
          $("quizResult").textContent = data.analysis || JSON.stringify(data);
        } catch (e) {
          $("quizResult").textContent = "Error: " + e.message;
        }
      };

      // Forum
      $("btnForum").onclick = async () => {
        if (!materialId) {
          alert("Upload material first");
          setActive("upload");
          return;
        }
        const prompt = $("promptForum").value || "";
        await runAndShow("/api/forum", { materialId, prompt }, "forumResult");
      };

      // Exam
      $("btnExam").onclick = async () => {
        if (!materialId) {
          alert("Upload material first");
          setActive("upload");
          return;
        }
        const prompt = $("promptExam").value || "";
        await runAndShow("/api/exam", { materialId, prompt }, "examResult");
      };

      // Flashcards
      $("btnGenerateCards").onclick = async () => {
        if (!materialId) {
          alert("Upload material first");
          setActive("upload");
          return;
        }
        const n = Number($("numCards").value || 5);
        const list = $("flashcardsList");
        list.innerHTML = "<em class='text-gray-500'>Generating...</em>";
        try {
          const res = await fetch("/api/flashcards", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ materialId, numCards: n }),
          });
          const data = await res.json();
          const cards = Array.isArray(data.cards) ? data.cards : [];
          renderFlashcards(cards);
        } catch (e) {
          list.innerHTML = "Error: " + e.message;
        }
      };

      function renderFlashcards(cards) {
        const list = $("flashcardsList");
        if (!cards || !cards.length) {
          list.innerHTML = "<em class='text-gray-500'>No flashcards.</em>";
          return;
        }
        const html = cards
          .map((c, i) => {
            const idx = i + 1;
            const q = (c.front || c.q || "").toString();
            const a = (c.back || c.a || "").toString();
            const id = "fc-" + (c.id || idx);
            return (
              '<div class="fc-scene">' +
              '<div class="fc-card" id="' +
              id +
              '" role="button" aria-label="Flip flashcard ' +
              idx +
              '" tabindex="0" ' +
              "onclick=\"flipCard('" +
              id +
              "')\" " +
              "onkeypress=\"if(event.key==='Enter'||event.key===' ') flipCard('" +
              id +
              "')\" >" +
              '<div class="fc-face fc-front">' +
              '<div class="text-sm sm:text-base"><span class="font-semibold text-primary">' +
              idx +
              ")</span> " +
              renderMarkdown(q) +
              "</div>" +
              '<div class="fc-hint">Click / Press Enter to flip</div>' +
              "</div>" +
              '<div class="fc-face fc-back">' +
              '<div class="text-sm sm:text-base">' +
              renderMarkdown(a) +
              "</div>" +
              '<div class="fc-hint">Click again to flip back</div>' +
              "</div>" +
              "</div>" +
              "</div>"
            );
          })
          .join("");
        list.innerHTML = html;
      }
      function flipCard(id) {
        const el = document.getElementById(id);
        if (el) el.classList.toggle("is-flipped");
      }

      // Chat (General)
      $("btnSend").onclick = sendChat;
      $("chatInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendChat();
        }
      });
      async function sendChat() {
        const input = $("chatInput");
        const text = (input.value || "").trim();
        if (!text) return;
        chat.push({ role: "user", content: text });
        input.value = "";
        renderChat();
        try {
          const payload = {
            materialId: materialId || undefined,
            messages: chat,
          };
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          const answer = data.answer || JSON.stringify(data);
          chat.push({ role: "assistant", content: answer });
          renderChat();
        } catch (e) {
          chat.push({ role: "system", content: "Chat error: " + e.message });
          renderChat();
        }
      }

      // Init (Chat first)
      setActive("chat");
      renderChat();

      // ===== Dialogue (coached conversation) =====
      let dialogueSessionId = null;
      let dialogueTopics = [];
      let dialogueIndex = 0;
      let dialogueStarted = false;
      let dialogueLanguage = null;
      let lastCoachQuestion = "";

      // Append a message to the Dialogue stream
      function renderDialogueStreamAppend(role, content) {
        const el = $("dialogueStream");
        if (!el) return;
        const who =
          role === "coach" ? "Coach" : role === "ilmatrix" ? "ilmatrix" : "You";
        const body =
          role === "coach" || role === "ilmatrix"
            ? renderMarkdown(content)
            : "<div class='whitespace-pre-wrap break-words text-sm sm:text-base'>" +
              escapeHtml(content) +
              "</div>";
        const html =
          '<div class="my-2">' +
          '<div class="text-xs text-gray-500 font-semibold mb-1">' +
          escapeHtml(who) +
          ":</div>" +
          body +
          "</div>";
        el.insertAdjacentHTML("beforeend", html);
        el.scrollTop = el.scrollHeight;
      }

      // Reset Dialogue UI state
      function resetDialogueUI() {
        dialogueSessionId = null;
        dialogueTopics = [];
        dialogueIndex = 0;
        dialogueStarted = false;
        dialogueLanguage = null;
        lastCoachQuestion = "";
        const s = $("dialogueStream");
        if (s)
          s.innerHTML =
            "<em class='text-gray-500'>Click Start to begin Dialogue.</em>";
        const start = $("btnDialogueStart");
        const begin = $("btnDialogueBegin");
        const input = $("dialogueInput");
        const send = $("btnDialogueSend");
        const hint = $("btnDialogueHint");
        if (start) start.classList.remove("hidden");
        if (begin) begin.classList.add("hidden");
        if (input) input.value = "";
        if (send) send.disabled = true;
        if (hint) hint.classList.add("hidden");
      }

      // Wire buttons (if the tab exists)
      const btnDialogueStart = $("btnDialogueStart");
      const btnDialogueBegin = $("btnDialogueBegin");
      const btnDialogueSend = $("btnDialogueSend");
      const btnDialogueHint = $("btnDialogueHint");

      if (btnDialogueStart) {
        btnDialogueStart.addEventListener("click", async () => {
          if (!materialId) {
            alert("Upload material first");
            setActive("upload");
            return;
          }
          try {
            const res = await fetch("/api/dialogue/start", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ materialId }),
            });
            const data = await res.json();
            dialogueSessionId = data.sessionId || null;
            dialogueTopics = Array.isArray(data.topics) ? data.topics : [];
            dialogueLanguage = data.language || null;

            // Show opener as "ilmatrix"
            const stream = $("dialogueStream");
            if (stream) stream.innerHTML = "";
            renderDialogueStreamAppend("ilmatrix", data.intro || "");
            lastCoachQuestion = data.firstCoachPrompt || "";
            dialogueStarted = true;

            btnDialogueStart.classList.add("hidden");
            btnDialogueBegin?.classList.remove("hidden");
            if (btnDialogueSend) btnDialogueSend.disabled = true;
            btnDialogueHint?.classList.add("hidden");
          } catch (e) {
            alert("Dialogue start failed: " + e.message);
          }
        });
      }

      if (btnDialogueBegin) {
        btnDialogueBegin.addEventListener("click", () => {
          btnDialogueBegin.classList.add("hidden");
          if (lastCoachQuestion) {
            renderDialogueStreamAppend("coach", lastCoachQuestion);
            if (btnDialogueSend) btnDialogueSend.disabled = false;
            btnDialogueHint?.classList.remove("hidden");
            $("dialogueInput")?.focus();
          }
        });
      }

      async function sendDialogue() {
        if (!dialogueStarted) return;
        const input = $("dialogueInput");
        const msg = (input?.value || "").trim();
        if (!msg) return;
        input.value = "";
        renderDialogueStreamAppend("you", msg);
        try {
          const payload = {
            sessionId: dialogueSessionId || undefined,
            materialId,
            topics: dialogueTopics,
            currentTopicIndex: dialogueIndex,
            userMessage: msg,
            lastCoachQuestion,
            language: dialogueLanguage || undefined,
          };
          const res = await fetch("/api/dialogue/step", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          const coachMsg = data.coachMessage || JSON.stringify(data);
          renderDialogueStreamAppend("coach", coachMsg);

          if (data.moveToNext) {
            dialogueIndex = dialogueIndex + 1;

            // finished all topics
            if (dialogueIndex >= (dialogueTopics?.length || 3)) {
              try {
                const fbRes = await fetch("/api/dialogue/feedback", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    materialId,
                    topics: dialogueTopics,
                    history: [], // optional
                    language: dialogueLanguage || undefined,
                  }),
                });
                const fb = await fbRes.json();
                let block = "";
                if (fb && (fb.feedback || fb.strengths || fb.improvements)) {
                  block += fb.feedback ? fb.feedback + "\n\n" : "";
                  if (Array.isArray(fb.strengths) && fb.strengths.length) {
                    block +=
                      (dialogueLanguage === "id"
                        ? "Kekuatan:\n"
                        : "Strengths:\n") +
                      fb.strengths.map((s) => "- " + s).join("\n") +
                      "\n\n";
                  }
                  if (
                    Array.isArray(fb.improvements) &&
                    fb.improvements.length
                  ) {
                    block +=
                      (dialogueLanguage === "id"
                        ? "Perbaikan:\n"
                        : "Improvements:\n") +
                      fb.improvements.map((s) => "- " + s).join("\n");
                  }
                } else {
                  block = coachMsg;
                }
                renderDialogueStreamAppend("coach", block);
              } catch (e) {
                renderDialogueStreamAppend(
                  "coach",
                  "Feedback error: " + e.message
                );
              }
              if (btnDialogueSend) btnDialogueSend.disabled = true;
              btnDialogueHint?.classList.add("hidden");
              return;
            }

            if (data.nextCoachQuestion) {
              lastCoachQuestion = data.nextCoachQuestion;
              renderDialogueStreamAppend("coach", data.nextCoachQuestion);
            }
          } else {
            if (data.nextCoachQuestion)
              lastCoachQuestion = data.nextCoachQuestion;
          }
        } catch (e) {
          renderDialogueStreamAppend(
            "coach",
            "Dialogue step error: " + e.message
          );
        }
      }

      if (btnDialogueSend) {
        btnDialogueSend.addEventListener("click", sendDialogue);
        $("dialogueInput")?.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendDialogue();
          }
        });
      }

      if (btnDialogueHint) {
        btnDialogueHint.addEventListener("click", async () => {
          if (!dialogueStarted) return;
          const title =
            (dialogueTopics && dialogueTopics[dialogueIndex]?.title) || "";
          try {
            const res = await fetch("/api/dialogue/hint", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                materialId,
                currentTopicTitle: title,
                language: dialogueLanguage || undefined,
              }),
            });
            const data = await res.json();
            const hint = data.hint || JSON.stringify(data);
            renderDialogueStreamAppend(
              "coach",
              (dialogueLanguage === "id" ? "Petunjuk: " : "Hint: ") + hint
            );
          } catch (e) {
            renderDialogueStreamAppend("coach", "Hint error: " + e.message);
          }
        });
      }
    </script>
  </body>
</html>
